## Description

Critical data in Azure Databricks should be encrypted with customer-managed keys to provide additional control over encryption keys and meet compliance requirements.

## Rationale

By default, Azure Databricks encrypts data at rest using Microsoft-managed keys. Using customer-managed keys (CMK) provides:
- Greater control over encryption keys
- Ability to rotate keys on your own schedule
- Capability to revoke access to data by revoking key access
- Compliance with regulatory requirements for key management
- Support for bring-your-own-key (BYOK) scenarios
- Enhanced audit trail for key usage

Customer-managed keys stored in Azure Key Vault can be used to encrypt:
- Managed services (notebooks, cluster configurations, secrets)
- DBFS root storage

This is particularly important for organizations with strict compliance requirements or those handling highly sensitive data.

## Audit

**From Azure Portal:**

1. Go to `Azure Databricks`
2. Select the workspace
3. Under `Settings`, click `Encryption`
4. Verify that `Customer-managed key encryption` is enabled for:
   - `Managed services` (workspace storage)
   - `DBFS root` (if applicable)
5. Note the Key Vault and key used

**From Azure CLI:**

```bash
# Check workspace encryption settings
az databricks workspace show \
  --name <workspace-name> \
  --resource-group <resource-group-name> \
  --query "{ManagedDiskEncryption:parameters.encryption, DBFSEncryption:parameters.requireInfrastructureEncryption}"
```

## Remediation

**Prerequisites:**

1. Create an Azure Key Vault in the same region as the Databricks workspace
2. Create or import a key in the Key Vault
3. Enable purge protection on the Key Vault
4. Grant the Databricks resource provider access to the Key Vault

**From Azure Portal:**

Note: Encryption must be configured during workspace creation.

1. Go to `Azure Databricks`
2. Click `+ Create`
3. Fill in the basic workspace details
4. Go to `Encryption` tab
5. For `Managed services encryption`:
   - Select `Enable`
   - Choose the Key Vault
   - Select the encryption key
6. For `DBFS root encryption` (optional):
   - Select `Enable`
   - Choose the Key Vault
   - Select the encryption key
7. Complete the workspace creation

**From Azure CLI:**

```bash
# Create workspace with CMK encryption
az databricks workspace create \
  --name <workspace-name> \
  --resource-group <resource-group-name> \
  --location <location> \
  --sku premium \
  --managed-resource-group <managed-rg-name> \
  --encryption-key-source Microsoft.Keyvault \
  --encryption-key-vault-uri <key-vault-uri> \
  --encryption-key-name <key-name> \
  --encryption-key-version <key-version>
```

**Update Existing Workspace:**

Unfortunately, encryption settings cannot be changed after workspace creation. To enable CMK for an existing workspace:

1. Export notebooks and configurations
2. Create a new workspace with CMK enabled
3. Import notebooks and reconfigure settings
4. Migrate data to the new workspace
5. Delete the old workspace

## References

- [Customer-managed keys for encryption](https://docs.microsoft.com/en-us/azure/databricks/security/keys/customer-managed-keys-managed-services)
- [DBFS root encryption with CMK](https://docs.microsoft.com/en-us/azure/databricks/security/keys/customer-managed-key-dbfs)
- [Azure Key Vault](https://docs.microsoft.com/en-us/azure/key-vault/general/overview)

