## Description

Entra ID tracks the behavior of sign-in events. If the Entra ID domain is licensed with P2, the sign-in behavior can be used as a detection mechanism for additional scrutiny during the sign-in event. If this policy is set up, then Risky Sign-in events will prompt users to use multi-factor authentication (MFA) tokens on login for additional verification.

## Rationale

Microsoft Entra ID Protection provides risk-based Conditional Access policies that use machine learning to detect anomalous sign-in behavior. When a sign-in is deemed risky (due to factors like impossible travel, unfamiliar locations, anonymous IP addresses, etc.), requiring MFA provides an additional layer of security.

This approach provides adaptive security that responds to potential threats in real-time, requiring additional verification only when needed. This balances security with user experience.

**Note:** This feature requires Azure AD Premium P2 licensing.

## Audit

**From Azure Portal:**

1. From Azure Home open the portal menu in the top left, and select `Microsoft Entra ID`
2. Select `Security`
3. Select `Conditional Access`
4. Review policies to identify a risk-based MFA policy
5. For a risky sign-in MFA policy, verify:
   - **Assignments > Users**: Should include `All users` or appropriate groups
   - **Assignments > Cloud apps or actions**: Should include `All cloud apps` or appropriate apps
   - **Assignments > Conditions > Sign-in risk**:
     - Configure: `Yes`
     - Select risk levels: `High`, `Medium`, and/or `Low` as per organizational policy
   - **Access controls > Grant**:
     - `Grant access` should be selected
     - `Require multi-factor authentication` should be checked
   - **Enable policy**: Should be `On`

**From PowerShell:**

```powershell
Connect-AzureAD
$policies = Get-AzureADMSConditionalAccessPolicy
foreach ($policy in $policies) {
    if ($policy.Conditions.SignInRiskLevels.Count -gt 0 -and
        $policy.GrantControls.BuiltInControls -contains "mfa") {
        Write-Host "Risk-based MFA policy found: $($policy.DisplayName)"
        Write-Host "Risk levels: $($policy.Conditions.SignInRiskLevels)"
        Write-Host "Policy State: $($policy.State)"
    }
}
```

## Remediation

**From Azure Portal:**

1. From Azure Home open the portal menu in the top left, and select `Microsoft Entra ID`
2. Select `Security`
3. Select `Conditional Access`
4. Click `+ New policy`
5. Enter a name for the policy (e.g., "Require MFA for risky sign-ins")
6. Under **Assignments**:
   - **Users**:
     - Include: `All users`
     - Exclude: Emergency access accounts if needed
   - **Cloud apps or actions**: Select `All cloud apps`
   - **Conditions > Sign-in risk**:
     - Configure: `Yes`
     - Select risk levels: Check `High` and `Medium` (adjust based on risk tolerance)
7. Under **Access controls > Grant**:
   - Select `Grant access`
   - Check `Require multi-factor authentication`
8. Set **Enable policy** to `Report-only` initially to test
9. After validating, set **Enable policy** to `On`
10. Click `Create`

**Prerequisites:**
- Azure AD Premium P2 licensing is required for this feature
- Ensure users are registered for MFA before enforcing the policy

**Important Notes:**
- Start with High risk only, then expand to Medium based on organizational needs
- Monitor Identity Protection reports to understand risk detections
- Consider user experience impact when selecting risk levels

## Default Value

By default, no risk-based Conditional Access policies are configured.

## References

- [What is Identity Protection?](https://docs.microsoft.com/en-us/azure/active-directory/identity-protection/overview-identity-protection)
- [Conditional Access: Sign-in risk-based Conditional Access](https://docs.microsoft.com/en-us/azure/active-directory/conditional-access/howto-conditional-access-policy-risk)
- [What is risk?](https://docs.microsoft.com/en-us/azure/active-directory/identity-protection/concept-identity-protection-risks)

