## Description

Network security groups should be periodically evaluated for port misconfigurations. Where SSH is not explicitly required and narrowly configured for resources attached to a network security group, Internet-level access to Azure resources should be restricted or eliminated.

## Rationale

Secure Shell (SSH) provides remote access to Linux-based systems using TCP port 22. While SSH is necessary for legitimate remote management of Linux VMs, exposing SSH directly to the Internet creates significant security risks similar to RDP:

**Security threats:**
- **Brute force attacks**: Automated tools constantly scan for and attack exposed SSH endpoints
- **Dictionary attacks**: Attackers try common usernames and passwords
- **Key-based attacks**: If private keys are compromised or weak, attackers can gain access
- **Exploitation of vulnerabilities**: SSH implementations have had security vulnerabilities
- **Credential stuffing**: Using leaked credentials from other breaches
- **Lateral movement**: Compromised SSH access enables broader network compromise
- **Cryptojacking**: Attackers use compromised systems to mine cryptocurrency
- **Bot networks**: Compromised systems added to botnets for DDoS attacks

**Attack landscape:**
- SSH is one of the most frequently attacked services on the Internet
- Millions of SSH brute force attempts occur daily
- Automated scanning tools identify exposed SSH services within minutes
- SSH is a primary target for both opportunistic and targeted attacks
- Compromised SSH access is commonly used for cryptomining and botnet operations

**Why Internet-level SSH access should be restricted:**
- **Reduces attack surface**: Eliminates exposure to automated scanning and attacks
- **Prevents unauthorized access**: Makes it significantly harder for attackers to reach SSH endpoints
- **Defense in depth**: Forces attackers to compromise other security layers first
- **Compliance**: Security frameworks and regulations often prohibit direct Internet exposure
- **Resource protection**: Prevents abuse of computational resources

**Acceptable alternatives to direct SSH exposure:**
- **Azure Bastion**: Provides secure SSH access through the Azure Portal without public IPs
- **VPN**: Requires VPN connection before accessing internal resources
- **Jump box/bastion host**: Single hardened system with limited exposure for accessing other systems
- **Just-in-Time (JIT) VM Access**: Temporarily opens SSH ports only when needed and approved
- **Point-to-Site VPN**: Secure connection from specific client machines
- **Site-to-Site VPN or ExpressRoute**: Private network connectivity for corporate access
- **SSH over Azure Relay**: Secure tunneling without public endpoints

**Additional SSH security considerations:**
- Disable password authentication (use keys only)
- Implement SSH key management and rotation
- Use non-standard ports (security through obscurity, not a primary defense)
- Enable SSH session logging and monitoring
- Implement fail2ban or similar brute-force protection
- Regular updates to SSH server software

The recommendation allows for narrowly scoped SSH access when required (e.g., from specific known IP addresses), but broad Internet access (0.0.0.0/0 or *) should never be permitted.

## Audit

**From Azure Portal:**

1. From Azure Home, select `All services`
2. Select `Network security groups` under Networking
3. For each Network Security Group:
   - Select the NSG
   - Select `Inbound security rules`
   - Review rules for:
     - Protocol: TCP
     - Destination port: 22
     - Source: `Any`, `Internet`, `0.0.0.0/0`, or `*`
     - Action: `Allow`
   - Verify no such rules exist, or if they do, they are narrowly scoped to specific IP addresses

**From Azure CLI:**

```bash
# List all NSGs
az network nsg list --query "[].{Name:name, ResourceGroup:resourceGroup}" -o table

# For each NSG, check for open SSH rules
az network nsg rule list --nsg-name <nsg-name> --resource-group <resource-group-name> --query "[?destinationPortRange=='22' && access=='Allow' && (sourceAddressPrefix=='*' || sourceAddressPrefix=='Internet' || sourceAddressPrefix=='0.0.0.0/0')].{Name:name, Priority:priority, Source:sourceAddressPrefix, Destination:destinationAddressPrefix}" -o table
```

**From PowerShell:**

```powershell
Connect-AzAccount

# Get all NSGs
$nsgs = Get-AzNetworkSecurityGroup

foreach ($nsg in $nsgs) {
    $sshRules = $nsg.SecurityRules | Where-Object {
        $_.DestinationPortRange -contains "22" -and
        $_.Access -eq "Allow" -and
        ($_.SourceAddressPrefix -eq "*" -or
         $_.SourceAddressPrefix -eq "Internet" -or
         $_.SourceAddressPrefix -eq "0.0.0.0/0")
    }

    if ($sshRules) {
        Write-Host "WARNING: NSG '$($nsg.Name)' has open SSH rules:" -ForegroundColor Red
        foreach ($rule in $sshRules) {
            Write-Host "  Rule: $($rule.Name), Priority: $($rule.Priority), Source: $($rule.SourceAddressPrefix)"
        }
    }
}
```

## Remediation

**Option 1: Remove the rule (Recommended if SSH not needed from Internet)**

**From Azure Portal:**
1. From Azure Home, select `All services`
2. Select `Network security groups`
3. Select the Network Security Group with the open rule
4. Select `Inbound security rules`
5. Select the rule allowing Internet SSH access
6. Click `Delete`
7. Confirm the deletion

**From Azure CLI:**
```bash
az network nsg rule delete --nsg-name <nsg-name> --resource-group <resource-group-name> --name <rule-name>
```

**From PowerShell:**
```powershell
$nsg = Get-AzNetworkSecurityGroup -Name <nsg-name> -ResourceGroupName <resource-group-name>
Remove-AzNetworkSecurityRuleConfig -NetworkSecurityGroup $nsg -Name <rule-name>
$nsg | Set-AzNetworkSecurityGroup
```

**Option 2: Restrict to specific IP addresses**

**From Azure Portal:**
1. Select the rule allowing Internet SSH access
2. Change `Source` from `Any` or `Internet` to `IP Addresses`
3. Enter specific IP addresses or CIDR ranges (e.g., your corporate office IP)
4. Click `Save`

**From Azure CLI:**
```bash
az network nsg rule update --nsg-name <nsg-name> --resource-group <resource-group-name> --name <rule-name> --source-address-prefixes <your-ip-address>/32
```

**From PowerShell:**
```powershell
$nsg = Get-AzNetworkSecurityGroup -Name <nsg-name> -ResourceGroupName <resource-group-name>
$rule = $nsg.SecurityRules | Where-Object {$_.Name -eq "<rule-name>"}
$rule.SourceAddressPrefix = "<your-ip-address>/32"
$nsg | Set-AzNetworkSecurityGroup
```

**Option 3: Implement Azure Bastion (Recommended)**

Azure Bastion provides secure SSH access without exposing VMs to the Internet:

1. From Azure Portal, search for `Bastions`
2. Click `+ Create`
3. Configure:
   - Subscription and resource group
   - Bastion name
   - Region (same as your VNet)
   - Tier (Basic or Standard)
   - Virtual Network
   - Create AzureBastionSubnet (minimum /26 subnet)
   - Public IP address for Bastion
4. Review and create

After deployment, access Linux VMs through:
1. Navigate to the VM in Azure Portal
2. Click `Connect` > `Bastion`
3. Choose authentication method (password or SSH key)
4. Connect securely without public IP on the VM

**Option 4: Implement Just-in-Time VM Access**

Requires Microsoft Defender for Cloud (Standard tier):

1. From Azure Portal, navigate to `Microsoft Defender for Cloud`
2. Select `Workload protections`
3. Select `Just-in-time VM access`
4. Select Linux VMs to configure
5. Click `Enable JIT on X VMs`
6. Configure:
   - Allowed ports (22 for SSH)
   - Maximum request time
   - Allowed source IPs
7. Users request access when needed

When access is needed:
1. Navigate to VM in Portal
2. Click `Connect` > `Just-in-time`
3. Request access
4. Specify source IP and time range
5. Access granted temporarily

**Best Practices:**

1. **Default deny**: Remove or deny all Internet-facing SSH rules by default

2. **Use key-based authentication**:
   ```bash
   # Disable password authentication in /etc/ssh/sshd_config
   PasswordAuthentication no
   ChallengeResponseAuthentication no
   ```

3. **Azure Bastion**: Provides secure, scalable access without public IPs

4. **JIT access**: Temporary access only when needed with approval

5. **VPN access**: Route all management traffic through VPN

6. **Monitoring and logging**:
   - Enable NSG flow logs
   - Monitor SSH authentication attempts
   - Alert on suspicious patterns
   - Use Azure Monitor for SSH logs

7. **SSH hardening**:
   - Disable root login
   - Use SSH protocol version 2
   - Configure SSH idle timeout
   - Limit user access with AllowUsers/AllowGroups
   - Keep SSH software updated

8. **Network segmentation**:
   - Use NSGs to isolate management subnets
   - Implement micro-segmentation for critical systems
   - Prevent lateral movement

9. **Regular audits**: Review NSG rules quarterly at minimum

10. **Jump boxes**: If direct access required, use hardened jump boxes in separate subnet with strict access controls

## Default Value

By default, when a Network Security Group is created, no rules allow SSH access from the Internet. However, administrators may create such rules, which should be avoided or strictly limited.

## References

- [Network security groups](https://docs.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview)
- [Security rules](https://docs.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview#security-rules)
- [What is Azure Bastion?](https://docs.microsoft.com/en-us/azure/bastion/bastion-overview)
- [Just-in-time VM access](https://docs.microsoft.com/en-us/azure/defender-for-cloud/just-in-time-access-usage)
- [SSH key management in Azure](https://docs.microsoft.com/en-us/azure/virtual-machines/linux/create-ssh-keys-detailed)
- [Azure security best practices for network security](https://docs.microsoft.com/en-us/azure/security/fundamentals/network-best-practices)

