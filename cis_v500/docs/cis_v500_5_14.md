## Description

Require administrators or appropriately delegated users to register third-party applications.

## Rationale

Application registration in Microsoft Entra ID allows applications to integrate with the identity platform and request access to organizational resources. By default, any user can register applications, which creates several security risks:

**Security concerns:**
- Users can create applications that access organizational data
- Registered applications can request OAuth permissions
- Applications created by users may not follow security best practices
- No oversight of what applications are being created
- Potential for shadow IT and unmanaged integrations
- Applications could be used for data exfiltration

**Governance challenges:**
- Difficulty tracking all registered applications
- No centralized approval process for new integrations
- Applications may proliferate without documentation
- Hard to maintain application lifecycle management
- Compliance and audit challenges

**Attack vectors:**
- Malicious users could register applications for attack purposes
- Consent phishing campaigns could use user-registered apps
- Applications could be created to harvest credentials
- Insider threats can create backdoor applications

By restricting application registration to administrators:
- IT maintains control over organizational integrations
- Security team can review and vet applications before registration
- Centralized governance of the application portfolio
- Better audit trail of who creates applications and why
- Reduced risk of malicious or poorly secured applications
- Compliance with security policies and standards

Administrators or specifically delegated users (Application Developer role) should be the only ones who can register applications.

## Audit

**From Azure Portal:**

1. From Azure Home open the portal menu in the top left, and select `Microsoft Entra ID`
2. Select `Users`
3. Select `User settings`
4. Under `App registrations`, check the setting for `Users can register applications`
5. Verify that it is set to `No`

**From PowerShell:**

```powershell
Connect-AzureAD
$policy = Get-AzureADMSAuthorizationPolicy
Write-Host "Users can register applications: $($policy.DefaultUserRolePermissions.AllowedToCreateApps)"
```

Should return `False`.

**From Azure CLI:**

```bash
az rest --method GET --uri "https://graph.microsoft.com/v1.0/policies/authorizationPolicy" --query "defaultUserRolePermissions.allowedToCreateApps"
```

Should return `false`.

## Remediation

**From Azure Portal:**

1. From Azure Home open the portal menu in the top left, and select `Microsoft Entra ID`
2. Select `Users`
3. Select `User settings`
4. Under `App registrations`, set `Users can register applications` to `No`
5. Click `Save`

**Note:** After making this change:
- Only Global Administrators, Application Administrators, and Cloud Application Administrators can register applications
- Users with the Application Developer role can also register applications if needed
- Regular users will receive an error if they attempt to register an application

**From PowerShell:**

```powershell
Connect-AzureAD
$policy = Get-AzureADMSAuthorizationPolicy

# Disable application registration for regular users
$policy.DefaultUserRolePermissions.AllowedToCreateApps = $false
Set-AzureADMSAuthorizationPolicy -Id $policy.Id -DefaultUserRolePermissions $policy.DefaultUserRolePermissions
```

**From Microsoft Graph API:**

```bash
az rest --method PATCH \
  --uri "https://graph.microsoft.com/v1.0/policies/authorizationPolicy/authorizationPolicy" \
  --headers "Content-Type=application/json" \
  --body '{"defaultUserRolePermissions":{"allowedToCreateApps":false}}'
```

**Delegating Application Registration (if needed):**

If you need to allow specific non-admin users to register applications:

1. Assign them the `Application Developer` role:
   ```powershell
   Connect-AzureAD
   $role = Get-AzureADDirectoryRole | Where-Object {$_.DisplayName -eq "Application Developer"}

   # Enable the role if not already enabled
   if (!$role) {
       $roleTemplate = Get-AzureADDirectoryRoleTemplate | Where-Object {$_.DisplayName -eq "Application Developer"}
       Enable-AzureADDirectoryRole -RoleTemplateId $roleTemplate.ObjectId
       $role = Get-AzureADDirectoryRole | Where-Object {$_.DisplayName -eq "Application Developer"}
   }

   # Add user to the role
   $user = Get-AzureADUser -Filter "userPrincipalName eq '<user@example.com>'"
   Add-AzureADDirectoryRoleMember -ObjectId $role.ObjectId -RefObjectId $user.ObjectId
   ```

**Best Practices:**

1. **Establish an application request process:**
   - Create a formal process for requesting new application registrations
   - Require business justification and security review
   - Document the purpose and owner of each application
   - Set up approval workflows

2. **Use appropriate administrative roles:**
   - Global Administrator - Full access (use sparingly)
   - Application Administrator - Can manage all aspects of app registrations
   - Cloud Application Administrator - Similar to Application Administrator
   - Application Developer - Can create app registrations only

3. **Application lifecycle management:**
   - Maintain an inventory of all registered applications
   - Document application owners and purposes
   - Regular review of registered applications
   - Remove unused or abandoned applications
   - Track application credentials and their expiration

4. **Security reviews:**
   - Review permissions requested by applications
   - Ensure applications follow security best practices
   - Verify appropriate use of service principals
   - Monitor application sign-in activity
   - Regular security assessments of custom applications

5. **Monitoring and auditing:**
   - Monitor application registration events in audit logs
   - Alert on new application registrations
   - Review application permissions and consent grants
   - Track changes to application configurations
   - Regular compliance audits

6. **User communication:**
   - Inform users about the restriction and reasons
   - Provide clear instructions for requesting application registration
   - Explain expected approval timelines
   - Offer guidance on appropriate use cases

## Default Value

By default, `Users can register applications` is set to `Yes`, allowing all users to register applications. This should be changed to `No`.

## References

- [Restrict application registration permissions](https://docs.microsoft.com/en-us/azure/active-directory/roles/permissions-reference#application-developer)
- [Default user permissions in Azure AD](https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/users-default-permissions)
- [Application and service principal objects in Azure Active Directory](https://docs.microsoft.com/en-us/azure/active-directory/develop/app-objects-and-service-principals)
- [Manage authorization policies](https://docs.microsoft.com/en-us/graph/api/resources/authorizationpolicy)

