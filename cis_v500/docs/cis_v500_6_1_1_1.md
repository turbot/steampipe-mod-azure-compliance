## Description

Enable Diagnostic settings for exporting activity logs. Diagnostic settings are available for each individual resource within a subscription. Settings should be configured for all appropriate resources for your environment.

## Rationale

A diagnostic setting controls how diagnostic logs are exported. By default, logs are retained only for 90 days in the Activity Log. Diagnostic settings allow you to send activity logs to:
- **Log Analytics workspace**: For querying, analysis, and alerting
- **Storage account**: For long-term archival (supports retention > 90 days)
- **Event Hub**: For streaming to external systems (SIEM, third-party tools)

**Why diagnostic settings are critical:**

**Compliance and auditing:**
- Many compliance frameworks require log retention beyond 90 days
- PCI DSS requires 3 months minimum, often 12 months
- HIPAA typically requires several years of retention
- SOC 2 requires adequate log retention for security monitoring
- Provides audit trail for investigations

**Security monitoring:**
- Enables centralized security monitoring through Log Analytics
- Supports correlation with other security logs
- Integration with Azure Sentinel for SIEM capabilities
- Real-time alerting on suspicious activities
- Historical analysis for threat hunting

**Operational insights:**
- Troubleshooting resource issues
- Understanding resource usage patterns
- Capacity planning based on actual activity
- Performance monitoring and optimization
- Cost management and optimization

**Incident response:**
- Forensic analysis during security incidents
- Timeline reconstruction for root cause analysis
- Understanding the scope of security breaches
- Evidence for legal and compliance investigations
- Post-incident review and lessons learned

**Activity logs capture:**
- **Administrative activities**: Resource creation, deletion, modification
- **Service health**: Outages, planned maintenance, health advisories
- **Autoscale**: Scaling events and decisions
- **Policy and alerts**: Policy evaluations, alert activations
- **Security**: Security-related events and recommendations

Without diagnostic settings configured, activity logs older than 90 days are lost forever, potentially leaving gaps in your security and compliance posture.

## Audit

**From Azure Portal:**

1. From Azure Home, search for `Monitor`
2. Select `Activity log`
3. Click `Export Activity Logs` or `Diagnostic settings`
4. Verify that at least one diagnostic setting exists
5. Check the configuration:
   - Ensure it captures all log categories (Administrative, Security, ServiceHealth, Alert, Recommendation, Policy, Autoscale)
   - Verify destination is configured (Log Analytics, Storage Account, or Event Hub)
   - For Storage Account destination, verify retention is appropriate

**From Azure CLI:**

```bash
# List diagnostic settings for subscription
az monitor diagnostic-settings subscription list --query "[].{Name:name, Logs:logs, Destination:workspaceId}" -o table

# Check if any diagnostic setting exists
az monitor diagnostic-settings subscription list --query "value[]" -o table
```

**From PowerShell:**

```powershell
Connect-AzAccount

# Get subscription context
$subscription = Get-AzSubscription -SubscriptionId (Get-AzContext).Subscription.Id

# Get diagnostic settings for subscription
$diagnosticSettings = Get-AzDiagnosticSetting -ResourceId "/subscriptions/$($subscription.Id)"

if ($diagnosticSettings.Count -eq 0) {
    Write-Host "WARNING: No diagnostic settings configured for subscription" -ForegroundColor Red
} else {
    Write-Host "Diagnostic settings found: $($diagnosticSettings.Count)" -ForegroundColor Green
    foreach ($setting in $diagnosticSettings) {
        Write-Host "  Setting: $($setting.Name)"
        Write-Host "    Workspace: $($setting.WorkspaceId)"
        Write-Host "    Storage: $($setting.StorageAccountId)"
        Write-Host "    Event Hub: $($setting.EventHubAuthorizationRuleId)"
    }
}
```

## Remediation

**Decision: Choose appropriate destination(s)**

Organizations typically choose one or more of:
- **Log Analytics workspace**: For analysis, alerting, and integration with Azure Sentinel
- **Storage account**: For long-term archival and compliance
- **Event Hub**: For streaming to external SIEM or monitoring systems

**Option 1: Create diagnostic setting with Log Analytics workspace (Recommended)**

**From Azure Portal:**

1. From Azure Home, search for `Monitor`
2. Select `Activity log`
3. Click `Export Activity Logs` or `Diagnostic settings`
4. Click `+ Add diagnostic setting`
5. Enter a name (e.g., "subscription-activity-logs")
6. Under **Logs**, select all categories:
   - Administrative
   - Security
   - ServiceHealth
   - Alert
   - Recommendation
   - Policy
   - Autoscale
   - ResourceHealth
7. Under **Destination details**, select `Send to Log Analytics workspace`
8. Choose your Log Analytics workspace
9. Click `Save`

**From Azure CLI:**

```bash
# Create Log Analytics workspace (if needed)
az monitor log-analytics workspace create \
  --resource-group <resource-group-name> \
  --workspace-name <workspace-name> \
  --location <region>

# Get workspace ID
WORKSPACE_ID=$(az monitor log-analytics workspace show \
  --resource-group <resource-group-name> \
  --workspace-name <workspace-name> \
  --query id -o tsv)

# Create diagnostic setting
az monitor diagnostic-settings subscription create \
  --name "subscription-activity-logs" \
  --location <region> \
  --workspace $WORKSPACE_ID \
  --logs '[
    {"category": "Administrative", "enabled": true},
    {"category": "Security", "enabled": true},
    {"category": "ServiceHealth", "enabled": true},
    {"category": "Alert", "enabled": true},
    {"category": "Recommendation", "enabled": true},
    {"category": "Policy", "enabled": true},
    {"category": "Autoscale", "enabled": true},
    {"category": "ResourceHealth", "enabled": true}
  ]'
```

**Option 2: Create diagnostic setting with Storage Account (for archival)**

```bash
# Create storage account (if needed)
az storage account create \
  --name <storage-account-name> \
  --resource-group <resource-group-name> \
  --location <region> \
  --sku Standard_GRS

# Get storage account ID
STORAGE_ID=$(az storage account show \
  --name <storage-account-name> \
  --resource-group <resource-group-name> \
  --query id -o tsv)

# Create diagnostic setting with storage and retention
az monitor diagnostic-settings subscription create \
  --name "subscription-activity-logs-archive" \
  --location <region> \
  --storage-account $STORAGE_ID \
  --logs '[
    {"category": "Administrative", "enabled": true, "retentionPolicy": {"days": 365, "enabled": true}},
    {"category": "Security", "enabled": true, "retentionPolicy": {"days": 365, "enabled": true}},
    {"category": "ServiceHealth", "enabled": true, "retentionPolicy": {"days": 365, "enabled": true}},
    {"category": "Alert", "enabled": true, "retentionPolicy": {"days": 365, "enabled": true}},
    {"category": "Recommendation", "enabled": true, "retentionPolicy": {"days": 365, "enabled": true}},
    {"category": "Policy", "enabled": true, "retentionPolicy": {"days": 365, "enabled": true}},
    {"category": "Autoscale", "enabled": true, "retentionPolicy": {"days": 365, "enabled": true}},
    {"category": "ResourceHealth", "enabled": true, "retentionPolicy": {"days": 365, "enabled": true}}
  ]'
```

**From PowerShell:**

```powershell
Connect-AzAccount

$subscriptionId = (Get-AzContext).Subscription.Id
$workspaceId = "/subscriptions/$subscriptionId/resourceGroups/<resource-group-name>/providers/Microsoft.OperationalInsights/workspaces/<workspace-name>"

# Define log categories
$logs = @()
$categories = @("Administrative", "Security", "ServiceHealth", "Alert", "Recommendation", "Policy", "Autoscale", "ResourceHealth")

foreach ($category in $categories) {
    $logs += New-AzDiagnosticSettingLogSettingsObject -Category $category -Enabled $true
}

# Create diagnostic setting
New-AzDiagnosticSetting `
  -Name "subscription-activity-logs" `
  -ResourceId "/subscriptions/$subscriptionId" `
  -WorkspaceId $workspaceId `
  -Log $logs
```

**Best Practices:**

1. **Enable all log categories**: Capture all available categories for complete visibility

2. **Use multiple destinations**:
   - Log Analytics for analysis and alerting
   - Storage Account for long-term archival
   - Event Hub for external SIEM integration

3. **Retention policies**:
   - Set appropriate retention in storage accounts
   - Consider compliance requirements
   - Balance storage costs with retention needs
   - Use lifecycle management to tier old logs to archive storage

4. **Automate with Azure Policy**:
   ```bash
   # Assign built-in policy to enforce diagnostic settings
   az policy assignment create \
     --name "enforce-diagnostic-settings" \
     --policy "/providers/Microsoft.Authorization/policyDefinitions/2465583e-4e78-4c15-b6be-a36cbc7c8b0f" \
     --scope "/subscriptions/<subscription-id>"
   ```

5. **Monitor diagnostic settings**:
   - Alert on diagnostic setting deletions or modifications
   - Regular audits to ensure settings remain configured
   - Verify logs are being received in destinations

6. **Integration with Azure Sentinel**:
   - Connect Log Analytics workspace to Azure Sentinel
   - Enable relevant analytics rules
   - Create custom queries for your environment

7. **Cost management**:
   - Monitor ingestion volumes
   - Use data retention policies
   - Consider workspace-level settings
   - Archive older logs to cheaper storage tiers

## Default Value

By default, activity logs are retained for 90 days in Azure Monitor. No diagnostic settings are configured by default, meaning logs older than 90 days are automatically deleted.

## References

- [Azure Activity Log](https://docs.microsoft.com/en-us/azure/azure-monitor/essentials/activity-log)
- [Create diagnostic settings](https://docs.microsoft.com/en-us/azure/azure-monitor/essentials/diagnostic-settings)
- [Activity log categories](https://docs.microsoft.com/en-us/azure/azure-monitor/essentials/activity-log-schema)
- [Azure Monitor best practices](https://docs.microsoft.com/en-us/azure/azure-monitor/best-practices)

