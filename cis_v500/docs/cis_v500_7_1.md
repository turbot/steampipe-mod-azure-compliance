## Description

Network security groups should be periodically evaluated for port misconfigurations. Where RDP is not explicitly required and narrowly configured for resources attached to a network security group, Internet-level access to Azure resources should be restricted or eliminated.

## Rationale

Remote Desktop Protocol (RDP) provides remote access to Windows-based virtual machines using TCP port 3389. While RDP is necessary for legitimate remote management, exposing RDP directly to the Internet creates significant security risks:

**Security threats:**
- **Brute force attacks**: Automated tools constantly scan for and attack exposed RDP endpoints
- **Credential stuffing**: Attackers use leaked credentials from other breaches
- **Exploitation of vulnerabilities**: RDP has had critical vulnerabilities (e.g., BlueKeep, DejaBlue)
- **Lateral movement**: Compromised RDP access can lead to broader network compromise
- **Ransomware**: Many ransomware attacks begin with compromised RDP access
- **Data exfiltration**: Attackers can use RDP to steal data from compromised systems

**Attack statistics:**
- RDP is one of the most commonly attacked services on the Internet
- Millions of brute force attempts occur daily
- RDP-related breaches are a leading cause of ransomware infections
- Exposed RDP is a favorite target for both automated attacks and threat actors

**Why Internet-level RDP access should be restricted:**
- **Reduces attack surface**: Eliminates exposure to automated scanning and attacks
- **Prevents unauthorized access**: Makes it much harder for attackers to reach RDP endpoints
- **Defense in depth**: Forces attackers to compromise other systems first
- **Compliance**: Many security frameworks prohibit direct Internet exposure of management protocols

**Acceptable alternatives to direct RDP exposure:**
- **Azure Bastion**: Provides secure RDP/SSH access through the Azure Portal without public IPs
- **VPN**: Requires VPN connection before accessing internal resources
- **Jump box/bastion host**: Single hardened system with limited exposure, used to access other systems
- **Just-in-Time (JIT) VM Access**: Temporarily opens RDP ports only when needed and approved
- **Point-to-Site VPN**: Secure connection from specific client machines
- **ExpressRoute or Site-to-Site VPN**: Private network connectivity for corporate access

The recommendation allows for narrowly scoped RDP access when required (e.g., from specific known IP addresses), but broad Internet access (0.0.0.0/0 or *) should never be permitted.

## Audit

**From Azure Portal:**

1. From Azure Home, select `All services`
2. Select `Network security groups` under Networking
3. For each Network Security Group:
   - Select the NSG
   - Select `Inbound security rules`
   - Review rules for:
     - Protocol: TCP
     - Destination port: 3389
     - Source: `Any`, `Internet`, `0.0.0.0/0`, or `*`
     - Action: `Allow`
   - Verify no such rules exist, or if they do, they are narrowly scoped to specific IP addresses

**From Azure CLI:**

```bash
# List all NSGs
az network nsg list --query "[].{Name:name, ResourceGroup:resourceGroup}" -o table

# For each NSG, check for open RDP rules
az network nsg rule list --nsg-name <nsg-name> --resource-group <resource-group-name> --query "[?destinationPortRange=='3389' && access=='Allow' && (sourceAddressPrefix=='*' || sourceAddressPrefix=='Internet' || sourceAddressPrefix=='0.0.0.0/0')].{Name:name, Priority:priority, Source:sourceAddressPrefix, Destination:destinationAddressPrefix}" -o table
```

**From PowerShell:**

```powershell
Connect-AzAccount

# Get all NSGs
$nsgs = Get-AzNetworkSecurityGroup

foreach ($nsg in $nsgs) {
    $rdpRules = $nsg.SecurityRules | Where-Object {
        $_.DestinationPortRange -contains "3389" -and
        $_.Access -eq "Allow" -and
        ($_.SourceAddressPrefix -eq "*" -or
         $_.SourceAddressPrefix -eq "Internet" -or
         $_.SourceAddressPrefix -eq "0.0.0.0/0")
    }

    if ($rdpRules) {
        Write-Host "WARNING: NSG '$($nsg.Name)' has open RDP rules:" -ForegroundColor Red
        foreach ($rule in $rdpRules) {
            Write-Host "  Rule: $($rule.Name), Priority: $($rule.Priority), Source: $($rule.SourceAddressPrefix)"
        }
    }
}
```

## Remediation

**Option 1: Remove the rule (Recommended if RDP not needed)**

**From Azure Portal:**
1. From Azure Home, select `All services`
2. Select `Network security groups`
3. Select the Network Security Group with the open rule
4. Select `Inbound security rules`
5. Select the rule allowing Internet RDP access
6. Click `Delete`
7. Confirm the deletion

**From Azure CLI:**
```bash
az network nsg rule delete --nsg-name <nsg-name> --resource-group <resource-group-name> --name <rule-name>
```

**From PowerShell:**
```powershell
Remove-AzNetworkSecurityRuleConfig -NetworkSecurityGroup $nsg -Name <rule-name>
$nsg | Set-AzNetworkSecurityGroup
```

**Option 2: Restrict to specific IP addresses**

**From Azure Portal:**
1. Select the rule allowing Internet RDP access
2. Change `Source` from `Any` or `Internet` to `IP Addresses`
3. Enter specific IP addresses or CIDR ranges (e.g., your corporate office IP)
4. Click `Save`

**From Azure CLI:**
```bash
az network nsg rule update --nsg-name <nsg-name> --resource-group <resource-group-name> --name <rule-name> --source-address-prefixes <your-ip-address>/32
```

**From PowerShell:**
```powershell
$nsg = Get-AzNetworkSecurityGroup -Name <nsg-name> -ResourceGroupName <resource-group-name>
$rule = $nsg.SecurityRules | Where-Object {$_.Name -eq "<rule-name>"}
$rule.SourceAddressPrefix = "<your-ip-address>/32"
$nsg | Set-AzNetworkSecurityGroup
```

**Option 3: Implement Azure Bastion (Recommended)**

Azure Bastion provides secure RDP/SSH access without exposing VMs to the Internet:

1. From Azure Portal, search for `Bastions`
2. Click `+ Create`
3. Select subscription and resource group
4. Provide a name
5. Select the region (same as your VNet)
6. Select or create a Virtual Network
7. Create a subnet named `AzureBastionSubnet` (minimum /26)
8. Create or select a public IP for Bastion
9. Review and create

After deployment, access VMs through:
1. Navigate to the VM in Azure Portal
2. Click `Connect` > `Bastion`
3. Enter credentials
4. Connect securely without public IP on the VM

**Option 4: Implement Just-in-Time VM Access**

Requires Azure Defender for Servers:

1. From Azure Portal, navigate to `Microsoft Defender for Cloud`
2. Select `Workload protections`
3. Select `Just-in-time VM access`
4. Select VMs to configure
5. Click `Enable JIT on X VMs`
6. Configure allowed ports and time windows
7. Users request access when needed, with approval workflow

**Best Practices:**

1. **Default deny**: Remove or deny all Internet-facing RDP rules by default
2. **Use Azure Bastion**: Provides secure, scalable access without public IPs
3. **JIT access**: Temporary access only when needed
4. **VPN access**: Route all management traffic through VPN
5. **Monitoring**: Enable NSG flow logs and alert on RDP access attempts
6. **Regular audits**: Periodically review NSG rules for misconfigurations
7. **Strong authentication**: Enforce strong passwords and disable password authentication where possible
8. **Least privilege**: Grant RDP access only to users who require it
9. **Jump boxes**: Use hardened jump boxes in a separate subnet if direct access is needed
10. **Network segmentation**: Use NSGs to prevent lateral movement

## Default Value

By default, when a Network Security Group is created, no rules allow RDP access from the Internet. However, administrators may create such rules, which should be avoided or strictly limited.

## References

- [Network security groups](https://docs.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview)
- [Security rules](https://docs.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview#security-rules)
- [What is Azure Bastion?](https://docs.microsoft.com/en-us/azure/bastion/bastion-overview)
- [Just-in-time VM access](https://docs.microsoft.com/en-us/azure/defender-for-cloud/just-in-time-access-usage)
- [Azure security best practices for network security](https://docs.microsoft.com/en-us/azure/security/fundamentals/network-best-practices)

