## Description

The principle of least privilege should be followed and only necessary privileges should be assigned instead of allowing full administrative access.

## Rationale

Azure provides built-in roles for managing access to resources through Role-Based Access Control (RBAC). The Owner role is the most privileged built-in role, granting full access to all resources including the ability to assign roles to others.

While Azure allows custom role creation, creating custom roles with Owner-equivalent permissions creates several security and governance risks:

**Security concerns:**
- Custom roles with Owner permissions bypass the principle of least privilege
- Difficult to track and audit compared to well-known built-in roles
- May grant excessive permissions not needed for the role's purpose
- Potential for privilege creep in custom role definitions
- Increased attack surface if custom role is compromised

**Governance challenges:**
- Built-in roles are well-documented and understood
- Custom Owner-equivalent roles are non-standard
- Difficult to maintain consistency across subscriptions
- Complexity in role management increases
- Audit and compliance reviews are harder
- Role sprawl with multiple similar custom roles

**Operational issues:**
- Confusion about what permissions each custom role has
- Increased administrative burden
- Difficult to explain in security reviews
- May violate organizational policies
- Inconsistent application of access controls

**When custom roles are appropriate:**
They should be used to grant *specific, limited* permissions, not full Owner access. For example:
- Read-only access to specific resource types
- Permission to perform specific operations (like starting/stopping VMs)
- Access to specific resource providers
- Granular control over particular actions

**Why this matters:**
If you need Owner-level access, use the built-in Owner role. If you don't need all Owner permissions, create a custom role with only the necessary permissions. Creating custom roles that duplicate or extend Owner permissions defeats the purpose of custom roles and creates security risks.

## Audit

**From Azure Portal:**

1. From Azure Home select `Subscriptions`
2. Select a subscription
3. Click `Access control (IAM)`
4. Click `Roles`
5. Filter to show only `Custom` roles
6. For each custom role:
   - Click on the role name
   - Review the permissions under `Permissions` tab
   - Check if the role has `Actions: *` or similar broad permissions
   - Verify if the role has `NotActions` that effectively grant Owner permissions

**From Azure CLI:**

```bash
# List all custom roles
az role definition list --custom-role-only true --query "[].{Name:roleName, Type:roleType}" -o table

# Get details of a specific custom role
az role definition list --name "<CustomRoleName>" --query "[].{Name:roleName, Actions:permissions[0].actions, NotActions:permissions[0].notActions}" -o json
```

**From PowerShell:**

```powershell
Connect-AzAccount

# Get all custom roles
$customRoles = Get-AzRoleDefinition | Where-Object {$_.IsCustom -eq $true}

foreach ($role in $customRoles) {
    Write-Host "`nRole Name: $($role.Name)"
    Write-Host "Actions: $($role.Actions -join ', ')"
    Write-Host "NotActions: $($role.NotActions -join ', ')"

    # Check for owner-like permissions
    if ($role.Actions -contains "*" -or
        ($role.Actions -contains "Microsoft.Authorization/roleAssignments/write" -and
         $role.Actions -contains "Microsoft.Resources/subscriptions/*")) {
        Write-Host "WARNING: This custom role has Owner-equivalent permissions!" -ForegroundColor Red
    }
}
```

**Indicators of Owner-equivalent custom roles:**
- `Actions` includes `*` (all actions)
- `Actions` includes `Microsoft.Authorization/roleAssignments/write` (can assign roles)
- `Actions` includes broad wildcards like `Microsoft.*/write`
- Combination of permissions that together equal Owner access
- `NotActions` is empty or very limited

## Remediation

**Step 1: Review and identify problematic custom roles**

Identify custom roles that grant Owner-equivalent permissions:

```powershell
Connect-AzAccount

$customRoles = Get-AzRoleDefinition | Where-Object {$_.IsCustom -eq $true}

foreach ($role in $customRoles) {
    if ($role.Actions -contains "*") {
        Write-Host "Owner-equivalent custom role found: $($role.Name)" -ForegroundColor Yellow

        # Get assignments of this role
        $assignments = Get-AzRoleAssignment -RoleDefinitionName $role.Name
        Write-Host "Number of assignments: $($assignments.Count)"
    }
}
```

**Step 2: Determine if the custom role is necessary**

For each Owner-equivalent custom role:
1. Determine why it was created
2. Identify who is using it
3. Assess if built-in Owner role would suffice
4. If not, determine the actual minimum permissions needed

**Step 3: Replace with appropriate role**

**Option A: Use built-in Owner role**

```powershell
# Get current assignments
$roleName = "<CustomRoleName>"
$assignments = Get-AzRoleAssignment -RoleDefinitionName $roleName

# For each assignment, replace with Owner role
foreach ($assignment in $assignments) {
    # Assign built-in Owner role
    New-AzRoleAssignment -ObjectId $assignment.ObjectId `
                         -RoleDefinitionName "Owner" `
                         -Scope $assignment.Scope

    # Remove custom role assignment
    Remove-AzRoleAssignment -ObjectId $assignment.ObjectId `
                           -RoleDefinitionName $roleName `
                           -Scope $assignment.Scope
}
```

**Option B: Create a properly scoped custom role**

Create a custom role with only necessary permissions:

```powershell
# Example: Custom role for specific operations only
$role = Get-AzRoleDefinition "Reader"
$role.Id = $null
$role.Name = "Custom Resource Manager"
$role.Description = "Can manage specific resource operations"
$role.Actions.Clear()
$role.Actions.Add("Microsoft.Resources/subscriptions/resourceGroups/read")
$role.Actions.Add("Microsoft.Compute/virtualMachines/read")
$role.Actions.Add("Microsoft.Compute/virtualMachines/start/action")
$role.Actions.Add("Microsoft.Compute/virtualMachines/restart/action")
$role.AssignableScopes.Clear()
$role.AssignableScopes.Add("/subscriptions/<subscription-id>")

New-AzRoleDefinition -Role $role
```

**Step 4: Delete the problematic custom role**

After migrating all assignments:

```powershell
# Remove the custom role
$role = Get-AzRoleDefinition -Name "<CustomRoleName>"
Remove-AzRoleDefinition -Id $role.Id -Force
```

**From Azure Portal:**

1. From Azure Home select `Subscriptions`
2. Select a subscription
3. Click `Access control (IAM)`
4. Click `Roles`
5. Find the custom role to remove
6. Ensure no assignments exist (or migrate them first)
7. Click the `...` menu and select `Delete`

**Best Practices:**

1. **Use built-in roles when possible:**
   - Azure provides many built-in roles
   - Well-documented and maintained by Microsoft
   - Regular updates and improvements
   - Widely understood and recognized

2. **Custom role guidelines:**
   - Create custom roles for specific, limited purposes only
   - Never replicate Owner permissions in a custom role
   - Use descriptive, clear names
   - Document the purpose and permissions
   - Regular review and audit of custom roles

3. **Permission design:**
   - Follow principle of least privilege
   - Grant only necessary permissions
   - Use specific actions rather than wildcards
   - Regularly review if permissions are still needed
   - Consider using eligible assignments (PIM) for high-privilege roles

4. **Governance:**
   - Establish approval process for custom role creation
   - Document all custom roles
   - Regular audits of custom role usage
   - Remove unused custom roles
   - Track why each custom role exists

5. **Alternative approaches:**
   - Consider if multiple built-in roles would work better
   - Use Azure AD Privileged Identity Management for just-in-time access
   - Implement approval workflows for high-privilege access
   - Use management groups for delegation at scale

## Default Value

By default, no custom roles exist. Organizations should avoid creating custom roles with Owner-equivalent permissions.

## References

- [Azure built-in roles](https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles)
- [Azure custom roles](https://docs.microsoft.com/en-us/azure/role-based-access-control/custom-roles)
- [Understand Azure role definitions](https://docs.microsoft.com/en-us/azure/role-based-access-control/role-definitions)
- [Best practices for Azure RBAC](https://docs.microsoft.com/en-us/azure/role-based-access-control/best-practices)

