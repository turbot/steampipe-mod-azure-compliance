## Description

Public network access should be disabled for Azure Databricks workspaces to ensure they are only accessible through private endpoints.

## Rationale

Disabling public network access for Databricks workspaces ensures that:
- The workspace is only accessible through private endpoints
- Traffic between users and the workspace stays within Azure's private network
- The workspace is not exposed to the public internet
- Reduced risk of unauthorized access and network-based attacks
- Better network isolation and compliance with security policies
- Integration with on-premises networks via ExpressRoute or VPN

When combined with private endpoints, this configuration ensures that all access to the Databricks workspace occurs through private IP addresses within your virtual network, providing enhanced security and control.

## Audit

**From Azure Portal:**

1. Go to `Azure Databricks`
2. Select the workspace
3. Under `Networking`, click `Private endpoint connections`
4. Verify that private endpoints are configured
5. Under `Networking`, check `Public network access`
6. Verify that it is set to `Disabled`

**From Azure CLI:**

```bash
az databricks workspace show \
  --name <workspace-name> \
  --resource-group <resource-group-name> \
  --query "publicNetworkAccess"
```

Expected output: `Disabled`

## Remediation

**Prerequisites:**

1. Deploy the workspace in a VNet (VNet injection)
2. Create private endpoints for the workspace
3. Ensure DNS is configured to resolve workspace URLs to private IPs

**From Azure Portal:**

1. Go to `Azure Databricks`
2. Select the workspace
3. Under `Networking`, click `Private endpoint connections`
4. If no private endpoints exist, create them:
   - Click `+ Private endpoint`
   - Follow the wizard to create private endpoints for:
     - Frontend (workspace URL)
     - Backend (web API)
5. After private endpoints are configured, under `Networking`:
6. Click `Firewalls and virtual networks`
7. Set `Public network access` to `Disabled`
8. Click `Save`

**From Azure CLI:**

```bash
# Update workspace to disable public access
az databricks workspace update \
  --name <workspace-name> \
  --resource-group <resource-group-name> \
  --public-network-access Disabled
```

**Create Private Endpoints:**

```bash
# Create private endpoint for workspace frontend
az network private-endpoint create \
  --name <pe-name-frontend> \
  --resource-group <resource-group-name> \
  --vnet-name <vnet-name> \
  --subnet <subnet-name> \
  --private-connection-resource-id <workspace-resource-id> \
  --group-id databricks_ui_api \
  --connection-name <connection-name>

# Create private endpoint for workspace backend
az network private-endpoint create \
  --name <pe-name-backend> \
  --resource-group <resource-group-name> \
  --vnet-name <vnet-name> \
  --subnet <subnet-name> \
  --private-connection-resource-id <workspace-resource-id> \
  --group-id browser_authentication \
  --connection-name <connection-name>
```

**Configure Private DNS:**

1. Create Private DNS zones:
   - `privatelink.azuredatabricks.net`
2. Link DNS zones to your VNet
3. Create DNS records pointing to private endpoint IPs

## References

- [Azure Private Link for Azure Databricks](https://docs.microsoft.com/en-us/azure/databricks/administration-guide/cloud-configurations/azure/private-link)
- [Disable public network access](https://docs.microsoft.com/en-us/azure/databricks/security/network/public-access)
- [Azure Private Endpoint](https://docs.microsoft.com/en-us/azure/private-link/private-endpoint-overview)

