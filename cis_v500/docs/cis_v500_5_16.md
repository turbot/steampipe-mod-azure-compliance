## Description

Restrict invitations to either users with specific administrative roles or no one.

## Rationale

Guest user invitations allow external users to be granted access to your organization's resources. While guest collaboration is valuable for business, unrestricted invitation capabilities create security risks:

**Security concerns with unrestricted invitations:**
- Any user can invite external parties without oversight
- No vetting of external users before they're granted access
- Potential for data exfiltration through unauthorized external access
- Difficulty tracking and managing all external collaborators
- Shadow IT scenarios where users bypass formal approval processes
- Insider threats can invite malicious external actors

**Risk scenarios:**
- Employees inviting personal accounts to access corporate resources
- Compromised accounts inviting attacker-controlled external users
- Well-meaning but uninformed users granting excessive access
- External users being invited to inappropriate resources
- Lack of documentation about why external access was granted

**Two recommended restriction levels:**

**Option 1: Only users assigned to specific admin roles can invite guests**
- Guest Inviter role can be assigned to specific users
- Administrators can invite guests
- Centralized control while allowing delegation
- Appropriate for organizations needing flexibility with oversight

**Option 2: No one can invite guests**
- Maximum restriction
- All guest invitations must be handled through alternative means (e.g., Access Packages)
- Appropriate for high-security environments
- Complete control over external access

By restricting guest invitations:
- IT maintains oversight of all external collaborators
- Security team can vet external users before access is granted
- Better compliance with data protection regulations
- Clear audit trail of who invited which guests and why
- Reduced risk of unauthorized data sharing
- Centralized guest user lifecycle management

## Audit

**From Azure Portal:**

1. From Azure Home open the portal menu in the top left, and select `Microsoft Entra ID`
2. Select `Users`
3. Select `User settings`
4. Click `Manage external collaboration settings`
5. Under `Guest invite settings`, check the current setting
6. Verify it is set to one of:
   - `Only users assigned to specific admin roles can invite guest users` (recommended)
   - `No one in the organization can invite guest users including admins` (most restrictive)

**From PowerShell:**

```powershell
Connect-AzureAD
$policy = Get-AzureADMSAuthorizationPolicy
Write-Host "Guest invite setting: $($policy.AllowInvitesFrom)"
```

Should return `adminsAndGuestInviters` or `none`.

**From Microsoft Graph API:**

```bash
az rest --method GET --uri "https://graph.microsoft.com/v1.0/policies/authorizationPolicy" --query "allowInvitesFrom"
```

## Remediation

**Option 1: Only specific admin roles can invite (Recommended for most organizations)**

**From Azure Portal:**
1. From Azure Home open the portal menu in the top left, and select `Microsoft Entra ID`
2. Select `Users`
3. Select `User settings`
4. Click `Manage external collaboration settings`
5. Under `Guest invite settings`, select:
   - `Only users assigned to specific admin roles can invite guest users`
6. Click `Save`

**Assign Guest Inviter role to specific users (if needed):**
1. From Azure Home open the portal menu in the top left, and select `Microsoft Entra ID`
2. Select `Roles and administrators`
3. Search for and click `Guest Inviter`
4. Click `+ Add assignments`
5. Select the users who should be able to invite guests
6. Click `Add`

**From PowerShell:**
```powershell
Connect-AzureAD
$policy = Get-AzureADMSAuthorizationPolicy
$policy.AllowInvitesFrom = "adminsAndGuestInviters"
Set-AzureADMSAuthorizationPolicy -Id $policy.Id -AllowInvitesFrom $policy.AllowInvitesFrom
```

**Option 2: No one can invite guests (Most restrictive)**

**From Azure Portal:**
1. From Azure Home open the portal menu in the top left, and select `Microsoft Entra ID`
2. Select `Users`
3. Select `User settings`
4. Click `Manage external collaboration settings`
5. Under `Guest invite settings`, select:
   - `No one in the organization can invite guest users including admins (most restrictive)`
6. Click `Save`

**From PowerShell:**
```powershell
Connect-AzureAD
$policy = Get-AzureADMSAuthorizationPolicy
$policy.AllowInvitesFrom = "none"
Set-AzureADMSAuthorizationPolicy -Id $policy.Id -AllowInvitesFrom $policy.AllowInvitesFrom
```

**From Microsoft Graph API:**

```bash
# For option 1 (admins and Guest Inviters)
az rest --method PATCH \
  --uri "https://graph.microsoft.com/v1.0/policies/authorizationPolicy/authorizationPolicy" \
  --headers "Content-Type=application/json" \
  --body '{"allowInvitesFrom":"adminsAndGuestInviters"}'

# For option 2 (no one)
az rest --method PATCH \
  --uri "https://graph.microsoft.com/v1.0/policies/authorizationPolicy/authorizationPolicy" \
  --headers "Content-Type=application/json" \
  --body '{"allowInvitesFrom":"none"}'
```

**Best Practices:**

1. **Use Access Packages for guest access (Recommended):**
   - Azure AD Entitlement Management provides controlled guest access
   - Automatic approval workflows
   - Time-limited access
   - Automatic access reviews
   - Better governance than direct invitations

2. **Establish a guest invitation request process:**
   - Create a formal process for requesting guest invitations
   - Require business justification
   - Define approval workflow
   - Document guest user purpose and scope
   - Set access expiration dates

3. **Assign Guest Inviter role appropriately:**
   - Only assign to users who regularly need to invite guests
   - Consider per-department guest inviters
   - Document why each user has the role
   - Review assignments regularly

4. **Alternative to direct invitations:**
   - Use SharePoint external sharing (if enabled)
   - Use Teams guest access
   - Use B2B direct connect for organization-to-organization sharing
   - Use Access Packages for self-service guest requests

5. **Monitoring and auditing:**
   - Review audit logs for guest invitation events
   - Monitor who is inviting guests
   - Track guest user creation and access patterns
   - Alert on unexpected invitation patterns

6. **Guest user lifecycle:**
   - Implement automatic guest access expiration
   - Regular reviews of guest users (see recommendation 5.3.2)
   - Remove guest access when no longer needed
   - Document guest user off-boarding process

7. **Additional controls:**
   - Restrict guest access to properties (see recommendation 5.15)
   - Use allowlist/blocklist for guest domains
   - Require guest users to accept terms of use
   - Apply Conditional Access policies to guests

## Default Value

By default, `Member users and users assigned to specific admin roles can invite guest users including guests with member permissions` may be the setting, which is not restrictive enough. Organizations should change this to one of the recommended settings.

## References

- [Configure external collaboration settings](https://docs.microsoft.com/en-us/azure/active-directory/external-identities/delegate-invitations)
- [Azure AD built-in roles - Guest Inviter](https://docs.microsoft.com/en-us/azure/active-directory/roles/permissions-reference#guest-inviter)
- [What is Azure AD entitlement management?](https://docs.microsoft.com/en-us/azure/active-directory/governance/entitlement-management-overview)
- [B2B collaboration overview](https://docs.microsoft.com/en-us/azure/active-directory/external-identities/what-is-b2b)

