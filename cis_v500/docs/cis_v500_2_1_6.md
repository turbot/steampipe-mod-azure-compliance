## Description

Personal access tokens in Azure Databricks should have restricted usage and enforced expiry to minimize security risks from long-lived or compromised tokens.

## Rationale

Personal access tokens (PATs) provide programmatic access to Databricks workspaces. Without proper controls, they can pose security risks:
- Long-lived tokens increase the window of opportunity for compromise
- Tokens without expiry can be forgotten and left active indefinitely
- Compromised tokens can be used for unauthorized access
- Unrestricted token creation can lead to unmanaged credentials

Enforcing token expiry and restricting token usage ensures:
- Regular token rotation
- Reduced risk from compromised credentials
- Better audit trail and token lifecycle management
- Compliance with security policies requiring credential rotation

## Audit

**From Databricks Workspace:**

1. Launch the Databricks workspace
2. Go to `Settings` > `Admin Console`
3. Click `Workspace settings`
4. Under `Personal access tokens`, verify:
   - Maximum token lifetime is configured (e.g., 90 days)
   - Token creation is restricted appropriately
5. Go to `Access control`
6. Review who has permission to create tokens

**Check Existing Tokens:**

1. In Databricks workspace, click on your user icon
2. Go to `User Settings`
3. Click `Access tokens`
4. Review all active tokens and their expiry dates
5. Verify no tokens are set to never expire

**From Databricks CLI:**

```bash
# List tokens (shows your own tokens)
databricks tokens list
```

## Remediation

**Configure Token Settings:**

1. In Databricks workspace, go to `Settings` > `Admin Console`
2. Click `Workspace settings`
3. Under `Personal access tokens`:
   - Enable `Token expiration required`
   - Set `Maximum token lifetime` to an appropriate value (e.g., 90 days)
   - Consider enabling `Restrict token creation` to admin users only
4. Click `Save`

**Rotate Existing Tokens:**

1. Identify tokens without expiry or with long expiry periods
2. Create new tokens with appropriate expiry dates:
   - Go to `User Settings` > `Access tokens`
   - Click `Generate new token`
   - Set `Lifetime (days)` to an appropriate value
   - Click `Generate`
3. Update applications/scripts to use the new token
4. Revoke old tokens:
   - Click `Revoke` next to the old token

**Implement Token Best Practices:**

1. Use service principals instead of personal access tokens where possible
2. Store tokens securely in Azure Key Vault
3. Rotate tokens regularly
4. Monitor token usage through audit logs
5. Revoke unused or suspicious tokens immediately

## References

- [Personal access token authentication](https://docs.microsoft.com/en-us/azure/databricks/dev-tools/auth#--personal-access-tokens)
- [Manage personal access tokens](https://docs.microsoft.com/en-us/azure/databricks/administration-guide/access-control/tokens)
- [Azure Databricks security best practices](https://docs.microsoft.com/en-us/azure/databricks/security/)

