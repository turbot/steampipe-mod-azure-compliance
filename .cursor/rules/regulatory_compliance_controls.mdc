---
description: 
globs: 
alwaysApply: true
---
# Regulatory Compliance Controls Structure

Controls and queries in this codebase follow a specific structure:

1. Location:
   - All controls and their associated queries should be in the `regulatory_compliance` directory
   - Files are organized by resource type (e.g., `network.pp`, `storage.pp`, `compute.pp`)
   - DO NOT create a separate query directory or .sp files
   - Always add queries to the corresponding resource type file in `regulatory_compliance`

2. File Naming:
   - Use `.pp` extension for all files
   - Name files based on the resource type they cover
   - Examples: 
     - `regulatory_compliance/network.pp` for network-related controls
     - `regulatory_compliance/storage.pp` for storage-related controls

3. Query Structure:
   - Queries should be defined in the same file as their associated controls
   - Place queries before the controls that reference them
   - Use clear, descriptive names that indicate the check being performed
   - Include all necessary SQL logic within the query block
   - SQL Style:
     - Use lowercase for all SQL keywords and functions (e.g., `select`, `from`, `where`, `with`, `as`, `count`, `sum`, `coalesce`, etc.)
     - Use meaningful aliases for table names
     - Format complex queries with appropriate indentation
     - Example:
       ```sql
       with contact_info as (
         select
           subscription_id,
           count(*) as contact_count
         from
           azure_security_center_contact
         where
           enabled = true
         group by
           subscription_id
       )
       ```

4. Control Structure:
   - Controls should reference queries defined in the same file
   - Use consistent tagging for categorization
   - Include clear titles and descriptions

5. Validation Requirements:
   - All queries MUST be tested using `steampipe query` before implementation
   - All controls MUST be validated using `powerpipe control run` before committing
   - Both query and control validation results should be verified for:
     - Correct column names and types
     - Proper error handling
     - Expected status and reason messages
     - Accurate control evaluation logic

Example:
```hcl
# In regulatory_compliance/network.pp

query "network_security_check" {
  sql = <<-EOQ
    select
      id as resource,
      case
        when is_enabled then 'ok'
        else 'alarm'
      end as status,
      name || ' is ' || case when is_enabled then 'enabled' else 'disabled' end as reason
    from
      azure_network_security_group
    where
      name = 'test';
  EOQ
}

control "network_security_control" {
  title       = "Network security control"
  description = "Ensures network security settings are properly configured"
  query       = query.network_security_check
  
  tags = local.regulatory_compliance_network_common_tags
}
```

DO NOT:
- Create a separate query folder
- Use .sp extension

## Required Structure

```hcl
control "service_control_name" {
  title       = "Clear descriptive title"
  description = "Detailed description of what this control checks"
  query       = query.control_query_name

  tags = merge(local.regulatory_compliance_service_common_tags, {
    framework1_name = "true"
    framework2_name = "true"
  })
}
```

## Key Components:

1. **Control Name**: Should be descriptive and follow the pattern `service_specific_check_name`

2. **Required Fields**:
   - `title` - Clear, action-oriented title
   - `description` - Detailed explanation of the control's purpose
   - `query` - Reference to the SQL query that implements the check

3. **Tags Structure**:
   - Uses service-specific common tags through merge
   - Framework-specific tags are added as boolean flags:
     - `hipaa_hitrust_v92`
     - `fedramp_high`
     - `nist_sp_800_171_rev_2`
     - `nist_sp_800_53_rev_5`
     - `rbi_itf_nbfc_v2017`

4. **Organization**:
   - Controls are grouped by service in separate files under `regulatory_compliance/`
   - Each service has its own common tags defined in locals

## Examples:

See [regulatory_compliance/keyvault.pp](mdc:regulatory_compliance/keyvault.pp) for KeyVault controls and [regulatory_compliance/monitor.pp](mdc:regulatory_compliance/monitor.pp) for Monitor controls.
