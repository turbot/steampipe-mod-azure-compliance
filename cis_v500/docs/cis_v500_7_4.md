## Description

Network security groups should be periodically evaluated for port misconfigurations. Where HTTP(S) is not explicitly required and narrowly configured for resources attached to a network security group, Internet-level access to Azure resources should be restricted or eliminated.

## Rationale

HTTP (port 80) and HTTPS (port 443) are the standard protocols for web traffic. While many Azure resources legitimately need to serve web content to the Internet, unrestricted HTTP/HTTPS access in Network Security Groups can create security concerns:

**Why careful evaluation is needed:**

**Different from RDP/SSH:**
Unlike RDP and SSH which should rarely be Internet-facing, HTTP/HTTPS is often legitimately required for:
- Public-facing web applications
- APIs and web services
- Application Gateway backends
- Load Balancer backends
- Azure App Service

However, direct exposure still requires careful consideration.

**Security concerns with unrestricted HTTP/HTTPS access:**

**Application-layer attacks:**
- SQL injection attacks
- Cross-site scripting (XSS)
- Cross-site request forgery (CSRF)
- Authentication bypass attempts
- Buffer overflow exploits
- Zero-day vulnerability exploitation

**DDoS attacks:**
- HTTP flood attacks
- Slowloris attacks
- Application-layer DDoS
- Resource exhaustion

**Data exposure:**
- Sensitive data transmitted over unencrypted HTTP
- Man-in-the-middle attacks on HTTP traffic
- Information disclosure through error messages
- Directory traversal attacks

**Bot and scraping attacks:**
- Content scraping
- Price scraping
- Credential stuffing
- Account takeover attempts
- API abuse

**Why evaluation and restriction is important:**

**Not all resources need direct Internet access:**
- Backend VMs should be behind Application Gateway or Load Balancer
- Internal APIs should not be Internet-facing
- Admin interfaces should be restricted
- Development/test environments should be isolated

**Better alternatives exist:**
- Azure Application Gateway with WAF
- Azure Front Door with WAF and DDoS protection
- Azure API Management for APIs
- Azure App Service with built-in security features
- Azure CDN for static content

**Security layering:**
Even when HTTP/HTTPS is required:
- Use Web Application Firewall (WAF)
- Implement DDoS protection
- Use Azure Front Door for edge security
- Enable Azure Monitor and logging
- Implement rate limiting
- Use HTTPS only (redirect HTTP to HTTPS)

**The recommendation emphasizes:**
- **Evaluate**: Determine if Internet access is truly needed
- **Restrict**: Where possible, use Azure services that provide built-in protection
- **Narrow configuration**: If direct access needed, limit to specific scenarios

## Audit

**From Azure Portal:**

1. From Azure Home, select `All services`
2. Select `Network security groups` under Networking
3. For each Network Security Group:
   - Select the NSG
   - Select `Inbound security rules`
   - Review rules allowing:
     - Protocol: TCP
     - Destination ports: 80, 443, or 80-443
     - Source: `Any`, `Internet`, `0.0.0.0/0`, or `*`
     - Action: `Allow`
   - For each such rule, evaluate:
     - Is the resource meant to be publicly accessible?
     - Could it be behind Application Gateway/Front Door instead?
     - Is WAF protection in place?
     - Is DDoS protection enabled?
     - Are appropriate monitoring and alerts configured?

**From Azure CLI:**

```bash
# List all NSGs
az network nsg list --query "[].{Name:name, ResourceGroup:resourceGroup}" -o table

# For each NSG, check for HTTP/HTTPS rules
az network nsg rule list --nsg-name <nsg-name> --resource-group <resource-group-name> --query "[?(destinationPortRange=='80' || destinationPortRange=='443' || destinationPortRange=='80-443') && access=='Allow' && (sourceAddressPrefix=='*' || sourceAddressPrefix=='Internet' || sourceAddressPrefix=='0.0.0.0/0')].{Name:name, Priority:priority, Port:destinationPortRange, Source:sourceAddressPrefix}" -o table
```

**From PowerShell:**

```powershell
Connect-AzAccount

# Get all NSGs
$nsgs = Get-AzNetworkSecurityGroup

foreach ($nsg in $nsgs) {
    $httpRules = $nsg.SecurityRules | Where-Object {
        ($_.DestinationPortRange -contains "80" -or
         $_.DestinationPortRange -contains "443" -or
         $_.DestinationPortRange -contains "80-443") -and
        $_.Access -eq "Allow" -and
        ($_.SourceAddressPrefix -eq "*" -or
         $_.SourceAddressPrefix -eq "Internet" -or
         $_.SourceAddressPrefix -eq "0.0.0.0/0")
    }

    if ($httpRules) {
        Write-Host "NSG '$($nsg.Name)' has HTTP/HTTPS rules from Internet:" -ForegroundColor Yellow
        foreach ($rule in $httpRules) {
            Write-Host "  Rule: $($rule.Name), Priority: $($rule.Priority), Ports: $($rule.DestinationPortRange)"
            # Note: Review if this is intentional and properly protected
        }
    }
}
```

## Remediation

**Decision Tree for HTTP/HTTPS Access:**

1. **Is this resource meant to be publicly accessible?**
   - NO → Remove the rule or restrict source IPs
   - YES → Continue to step 2

2. **Can this resource be behind Application Gateway or Front Door?**
   - YES → Place behind Application Gateway/Front Door (recommended)
   - NO → Continue to step 3

3. **Is WAF protection in place?**
   - NO → Implement WAF protection
   - YES → Continue to step 4

4. **Is DDoS protection enabled?**
   - NO → Enable Azure DDoS Protection
   - YES → Ensure monitoring and logging are configured

**Option 1: Remove direct Internet access (for backend resources)**

**From Azure Portal:**
1. Navigate to the Network Security Group
2. Select `Inbound security rules`
3. Delete the rule allowing Internet HTTP/HTTPS access
4. Place resource behind Application Gateway or Load Balancer

**From Azure CLI:**
```bash
az network nsg rule delete --nsg-name <nsg-name> --resource-group <resource-group-name> --name <rule-name>
```

**Option 2: Implement Application Gateway with WAF (Recommended)**

1. Create Application Gateway with WAF:
```bash
az network application-gateway create \
  --name <app-gateway-name> \
  --resource-group <resource-group-name> \
  --location <region> \
  --vnet-name <vnet-name> \
  --subnet <subnet-name> \
  --sku WAF_v2 \
  --http-settings-cookie-based-affinity Disabled \
  --frontend-port 80 \
  --http-settings-port 80 \
  --http-settings-protocol Http \
  --public-ip-address <public-ip-name>
```

2. Enable WAF:
```bash
az network application-gateway waf-config set \
  --enabled true \
  --gateway-name <app-gateway-name> \
  --resource-group <resource-group-name> \
  --firewall-mode Prevention \
  --rule-set-version 3.2
```

3. Configure backend pool with your VMs
4. Remove public IPs from backend VMs
5. Update NSG to allow traffic only from Application Gateway subnet

**Option 3: Use Azure Front Door with WAF**

1. Create Azure Front Door:
```bash
az network front-door create \
  --resource-group <resource-group-name> \
  --name <front-door-name> \
  --backend-address <backend-address>
```

2. Create and associate WAF policy:
```bash
az network front-door waf-policy create \
  --resource-group <resource-group-name> \
  --name <waf-policy-name> \
  --mode Prevention

az network front-door update \
  --name <front-door-name> \
  --resource-group <resource-group-name> \
  --set frontendEndpoints[0].webApplicationFirewallPolicyLink.id=/subscriptions/<subscription-id>/resourceGroups/<resource-group-name>/providers/Microsoft.Network/frontDoorWebApplicationFirewallPolicies/<waf-policy-name>
```

**Option 4: Restrict source IPs (for limited public access)**

If only specific IPs need access:

**From Azure Portal:**
1. Edit the HTTP/HTTPS rule
2. Change `Source` from `Any` to `IP Addresses`
3. Enter specific IP addresses or CIDR ranges
4. Click `Save`

**From Azure CLI:**
```bash
az network nsg rule update \
  --nsg-name <nsg-name> \
  --resource-group <resource-group-name> \
  --name <rule-name> \
  --source-address-prefixes <ip-address>/32
```

**Option 5: Enable DDoS Protection**

```bash
# Create DDoS protection plan
az network ddos-protection create \
  --resource-group <resource-group-name> \
  --name <ddos-plan-name>

# Enable on VNet
az network vnet update \
  --resource-group <resource-group-name> \
  --name <vnet-name> \
  --ddos-protection true \
  --ddos-protection-plan <ddos-plan-id>
```

**Best Practices:**

1. **Use HTTPS only**:
   - Redirect HTTP (80) to HTTPS (443)
   - Use strong TLS configurations (TLS 1.2 or higher)
   - Implement HTTP Strict Transport Security (HSTS)

2. **Implement layered security**:
   - WAF for application-layer protection
   - DDoS Protection for volumetric attacks
   - Azure Front Door for edge security
   - Rate limiting to prevent abuse

3. **Architecture recommendations**:
   - Never expose backend VMs directly to Internet
   - Use Application Gateway or Front Door
   - Implement CDN for static content
   - Use API Management for APIs

4. **Monitoring and logging**:
   - Enable NSG flow logs
   - Configure WAF logs
   - Set up Azure Monitor alerts
   - Track failed requests and attacks
   - Regular review of access patterns

5. **Security headers**:
   - Content Security Policy (CSP)
   - X-Frame-Options
   - X-Content-Type-Options
   - Referrer-Policy

6. **Regular security assessments**:
   - Vulnerability scanning
   - Penetration testing
   - Security audits
   - Review of access patterns

7. **Certificate management**:
   - Use Azure Key Vault for certificate storage
   - Implement certificate rotation
   - Monitor certificate expiration
   - Use managed certificates where possible

## Default Value

By default, Network Security Groups do not allow HTTP/HTTPS traffic from the Internet. Rules must be explicitly created. Unlike RDP/SSH, HTTP/HTTPS Internet access may be legitimate but should be properly secured.

## References

- [Azure Application Gateway](https://docs.microsoft.com/en-us/azure/application-gateway/overview)
- [Web Application Firewall on Application Gateway](https://docs.microsoft.com/en-us/azure/web-application-firewall/ag/ag-overview)
- [Azure Front Door](https://docs.microsoft.com/en-us/azure/frontdoor/front-door-overview)
- [Azure DDoS Protection](https://docs.microsoft.com/en-us/azure/ddos-protection/ddos-protection-overview)
- [Network security groups](https://docs.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview)
- [Azure security best practices](https://docs.microsoft.com/en-us/azure/security/fundamentals/network-best-practices)

