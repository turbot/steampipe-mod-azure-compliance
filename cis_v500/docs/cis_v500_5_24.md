## Description

Resource locking is a powerful protection mechanism that can prevent inadvertent modification or deletion of resources within Azure subscriptions and resource groups, and it is a recommended NIST configuration.

## Rationale

Azure resource locks prevent accidental or malicious deletion or modification of critical resources. However, managing resource locks requires specific permissions that are not included in common built-in roles. This creates a challenge:

**The problem:**
- The Owner and Contributor roles can create resources but NOT manage locks
- To manage locks, users typically need Owner role at subscription level
- This violates the principle of least privilege
- Organizations need someone to manage locks without full Owner access

**The solution:**
A custom role specifically for managing resource locks allows organizations to:
- Delegate lock management without granting full Owner access
- Follow principle of least privilege
- Maintain separation of duties
- Ensure critical resources remain protected

**Why resource locks are important:**
- **Prevent accidental deletion**: Protect production resources from being deleted
- **Prevent modification**: Ensure critical configuration doesn't change
- **Compliance requirements**: Meet regulatory requirements for resource protection
- **Business continuity**: Protect infrastructure critical to operations
- **Cost management**: Prevent deletion of resources that take time/money to recreate

**Lock types:**
- **CanNotDelete**: Can modify but not delete the resource
- **ReadOnly**: Can read but not modify or delete the resource

**Who should manage locks:**
- Security team members
- Compliance officers
- Senior infrastructure engineers
- Change management personnel

This is a CIS Level 2 recommendation, indicating it's for organizations with advanced security and compliance requirements.

## Audit

**Manual Review:**

This is a manual control. Review requires:
1. Verify that resource locks are being used for critical resources
2. Confirm that a custom role exists for managing locks
3. Check that appropriate personnel are assigned the lock management role
4. Ensure lock management doesn't require full Owner access

**From Azure Portal:**

1. From Azure Home select `Subscriptions`
2. Select a subscription
3. Click `Access control (IAM)`
4. Click `Roles`
5. Look for a custom role for managing resource locks
6. Review the role to ensure it has:
   - `Microsoft.Authorization/locks/read`
   - `Microsoft.Authorization/locks/write`
   - `Microsoft.Authorization/locks/delete`
   - And minimal other permissions

**From PowerShell:**

```powershell
Connect-AzAccount

# Check if a custom role for lock management exists
$roles = Get-AzRoleDefinition | Where-Object {$_.IsCustom -eq $true}

foreach ($role in $roles) {
    $hasLockRead = $role.Actions -contains "Microsoft.Authorization/locks/read" -or
                   $role.Actions -contains "Microsoft.Authorization/locks/*" -or
                   $role.Actions -contains "Microsoft.Authorization/*" -or
                   $role.Actions -contains "*"

    $hasLockWrite = $role.Actions -contains "Microsoft.Authorization/locks/write" -or
                    $role.Actions -contains "Microsoft.Authorization/locks/*" -or
                    $role.Actions -contains "Microsoft.Authorization/*" -or
                    $role.Actions -contains "*"

    if ($hasLockRead -and $hasLockWrite) {
        Write-Host "Custom role with lock permissions found: $($role.Name)"
        Write-Host "Actions: $($role.Actions -join ', ')"
    }
}
```

**Check for lock usage:**

```powershell
# Check locks at subscription level
Get-AzResourceLock

# Check locks for specific resource group
Get-AzResourceLock -ResourceGroupName "<ResourceGroupName>"
```

## Remediation

**Step 1: Create a custom role for resource lock management**

**From PowerShell:**

```powershell
Connect-AzAccount
$subscriptionId = (Get-AzContext).Subscription.Id

$role = [Microsoft.Azure.Commands.Resources.Models.Authorization.PSRoleDefinition]@{
    Name = "Resource Lock Manager"
    Description = "Can create, modify, and delete resource locks without requiring Owner permissions"
    IsCustom = $true
    Actions = @(
        "Microsoft.Authorization/locks/read",
        "Microsoft.Authorization/locks/write",
        "Microsoft.Authorization/locks/delete",
        "*/read"  # Read access to see resources
    )
    NotActions = @()
    AssignableScopes = @("/subscriptions/$subscriptionId")
}

New-AzRoleDefinition -Role $role
```

**From Azure CLI:**

```bash
# Create a JSON file with role definition
cat > resource-lock-manager.json << EOF
{
  "Name": "Resource Lock Manager",
  "IsCustom": true,
  "Description": "Can create, modify, and delete resource locks",
  "Actions": [
    "Microsoft.Authorization/locks/read",
    "Microsoft.Authorization/locks/write",
    "Microsoft.Authorization/locks/delete",
    "*/read"
  ],
  "NotActions": [],
  "AssignableScopes": [
    "/subscriptions/<subscription-id>"
  ]
}
EOF

# Create the role
az role definition create --role-definition resource-lock-manager.json
```

**From Azure Portal:**

1. From Azure Home select `Subscriptions`
2. Select a subscription
3. Click `Access control (IAM)`
4. Click `Roles`
5. Click `+ Add` > `Add custom role`
6. Enter name: `Resource Lock Manager`
7. Enter description
8. Click `Start from scratch`
9. On the Permissions tab, click `+ Add permissions`
10. Search for `Microsoft.Authorization`
11. Expand and select:
    - `locks/read`
    - `locks/write`
    - `locks/delete`
12. Add `*/read` if needed for viewing resources
13. Set assignable scope to subscription
14. Review and create

**Step 2: Assign the role to appropriate users**

```powershell
# Assign the custom role to a user or group
New-AzRoleAssignment -SignInName "<user@example.com>" `
                     -RoleDefinitionName "Resource Lock Manager" `
                     -Scope "/subscriptions/<subscription-id>"

# Or assign to a group
$group = Get-AzADGroup -DisplayName "Lock Administrators"
New-AzRoleAssignment -ObjectId $group.Id `
                     -RoleDefinitionName "Resource Lock Manager" `
                     -Scope "/subscriptions/<subscription-id>"
```

**Step 3: Implement resource locks on critical resources**

```powershell
# Create CanNotDelete lock on a resource group
New-AzResourceLock -LockName "DoNotDeleteProd" `
                   -LockLevel CanNotDelete `
                   -ResourceGroupName "Production-RG" `
                   -LockNotes "Protects production resources"

# Create ReadOnly lock on a critical resource
New-AzResourceLock -LockName "PreventChanges" `
                   -LockLevel ReadOnly `
                   -ResourceName "CriticalVM" `
                   -ResourceType "Microsoft.Compute/virtualMachines" `
                   -ResourceGroupName "Production-RG"
```

**Best Practices:**

1. **Lock strategy:**
   - Apply locks to all production resources
   - Use CanNotDelete for resources that need modifications
   - Use ReadOnly for resources that should never change
   - Document which resources are locked and why
   - Regular review of lock effectiveness

2. **Custom role permissions:**
   - Keep the role focused on lock management
   - Add only necessary permissions
   - Don't grant broad administrative access
   - Regular review of who has the role
   - Document why each person has the role

3. **Lock management process:**
   - Establish process for requesting lock changes
   - Require justification for removing locks
   - Temporary lock removal should be documented
   - Locks should be reapplied after changes
   - Audit log review for lock changes

4. **Lock placement:**
   - Consider locks at multiple levels:
     - Subscription level for broad protection
     - Resource group level for logical groupings
     - Individual resource level for critical resources
   - Locks inherit from parent scopes
   - Child scope locks provide more specific protection

5. **Integration with change management:**
   - Lock changes should follow change control process
   - Emergency procedures for urgent lock removal
   - Post-change validation that locks are restored
   - Regular audits of lock status

6. **Documentation:**
   - Document which resources should be locked
   - Explain the purpose of each lock
   - List who can manage locks
   - Procedure for requesting lock changes
   - Emergency contact for lock issues

7. **Monitoring:**
   - Monitor for lock creation/deletion events
   - Alert on unexpected lock changes
   - Review who is making lock changes
   - Track resources that should be locked but aren't
   - Compliance reporting on lock coverage

## Default Value

By default, no custom role exists for resource lock management. Organizations must create this role if they want to delegate lock management without granting Owner access.

## References

- [Lock resources to prevent unexpected changes](https://docs.microsoft.com/en-us/azure/azure-resource-manager/management/lock-resources)
- [Azure custom roles](https://docs.microsoft.com/en-us/azure/role-based-access-control/custom-roles)
- [Understand scope for Azure RBAC](https://docs.microsoft.com/en-us/azure/role-based-access-control/scope-overview)
- [Best practices for Azure Resource Manager](https://docs.microsoft.com/en-us/azure/azure-resource-manager/management/best-practices)

