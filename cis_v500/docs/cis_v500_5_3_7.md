## Description

Perform a periodic review of non-privileged role assignments to ensure that the nonprivileged roles assigned to users are appropriate.

## Rationale

While privileged roles receive most of the security attention, non-privileged role assignments also require regular review. Non-privileged roles include built-in roles such as:
- Reader
- Contributor (on specific resources, not at subscription level)
- Resource-specific roles (e.g., Virtual Machine Contributor, Storage Account Contributor)
- Custom roles with limited permissions

Regular reviews of non-privileged role assignments are important for:
- Ensuring users have only the access they need for their current job functions
- Identifying and removing access for users who have changed roles or left the organization
- Detecting privilege creep where users accumulate permissions over time
- Maintaining compliance with regulatory requirements
- Reducing the attack surface by removing unnecessary access
- Implementing the principle of least privilege across all permission levels

Organizations should conduct formal reviews of non-privileged role assignments at least annually, or more frequently for high-risk environments. Reviews should cover:
- Azure RBAC role assignments at all scopes (management group, subscription, resource group, resource)
- Access to specific resources like storage accounts, databases, and virtual machines
- Group memberships that grant Azure resource access
- Business justification for each access grant

## Audit

**Manual Audit Process:**

1. Generate reports of all role assignments across subscriptions and resource groups
2. Review assignments with resource owners and managers
3. Verify each assignment is still needed for current job functions
4. Document review findings and remediation actions
5. Track assignment age and flag old assignments for special review

**From Azure Portal:**

1. From Azure Home select `Subscriptions`
2. For each subscription:
   - Select the subscription
   - Click `Access control (IAM)`
   - Click `Role assignments`
   - Review all non-privileged role assignments
   - Note the user, role, and scope for each assignment
3. Repeat for Resource Groups:
   - Navigate to each resource group
   - Click `Access control (IAM)`
   - Review role assignments at resource group level

**From PowerShell:**

```powershell
Connect-AzAccount

# Get all subscriptions
$subscriptions = Get-AzSubscription

# Define privileged roles to exclude from this review
$privilegedRoles = @(
    "Owner",
    "Contributor" # at subscription level
)

$report = @()
foreach ($sub in $subscriptions) {
    Set-AzContext -SubscriptionId $sub.Id
    Write-Host "Reviewing subscription: $($sub.Name)"

    # Get all role assignments
    $roleAssignments = Get-AzRoleAssignment

    foreach ($assignment in $roleAssignments) {
        # Filter out subscription-level privileged roles
        if ($assignment.Scope -like "/subscriptions/*" -and
            $assignment.Scope.Split('/').Count -eq 3 -and
            $privilegedRoles -contains $assignment.RoleDefinitionName) {
            continue # Skip privileged roles at subscription level
        }

        $report += [PSCustomObject]@{
            Subscription = $sub.Name
            Principal = $assignment.DisplayName
            PrincipalType = $assignment.ObjectType
            Role = $assignment.RoleDefinitionName
            Scope = $assignment.Scope
            ScopeType = if ($assignment.Scope -like "*/resourceGroups/*") { "ResourceGroup" }
                       elseif ($assignment.Scope -like "*/providers/*") { "Resource" }
                       else { "Subscription" }
        }
    }
}

# Export to CSV for review
$report | Export-Csv -Path "NonPrivilegedRoleAssignments.csv" -NoTypeInformation
Write-Host "Report exported to NonPrivilegedRoleAssignments.csv"
```

**From Azure CLI:**

```bash
# Get role assignments for all subscriptions
for subscription in $(az account list --query "[].id" -o tsv); do
    echo "Subscription: $subscription"
    az role assignment list --all --subscription $subscription --query "[?roleDefinitionName!='Owner'].{Principal:principalName, Role:roleDefinitionName, Scope:scope}" -o table
done
```

## Remediation

**Establish a Regular Review Process:**

1. **Create a review schedule:**
   - Set up annual reviews of all non-privileged role assignments
   - Assign responsibility to resource owners and managers
   - Create a standardized review template and workflow

2. **Remove unnecessary role assignments:**

   **From Azure Portal:**
   - Navigate to the subscription, resource group, or resource
   - Click `Access control (IAM)`
   - Click `Role assignments`
   - Select the assignment to remove
   - Click `Remove`

   **From PowerShell:**
   ```powershell
   Connect-AzAccount
   Set-AzContext -SubscriptionId <subscription-id>

   # Remove a specific role assignment
   Remove-AzRoleAssignment -ObjectId <object-id> -RoleDefinitionName <role-name> -Scope <scope>

   # Example
   Remove-AzRoleAssignment -SignInName user@example.com -RoleDefinitionName "Storage Blob Data Reader" -ResourceGroupName "myResourceGroup"
   ```

   **From Azure CLI:**
   ```bash
   # Remove a role assignment
   az role assignment delete --assignee <user-principal-name> --role <role-name> --scope <scope>

   # Example
   az role assignment delete --assignee user@example.com --role "Virtual Machine Contributor" --resource-group myResourceGroup
   ```

3. **Implement Azure AD Access Reviews (Recommended - Requires Azure AD Premium P2):**

   **From Azure Portal:**
   - From Azure Home open the portal menu in the top left, and select `Microsoft Entra ID`
   - Select `Identity Governance`
   - Select `Access reviews`
   - Click `+ New access review`
   - Configure:
     - Review name: "Non-Privileged Azure Role Assignment Review"
     - Resource: Azure resources
     - Select subscriptions or resource groups to review
     - Scope: All users
     - Reviewers: Resource owners or managers
     - Frequency: Annually
     - Duration: 30 days
   - Click `Start`

4. **Best practices:**
   - Use groups for role assignments instead of individual users where possible
   - Document business justification for access grants
   - Set expiration dates on temporary access grants
   - Monitor role assignment changes through Azure Activity Log
   - Consider using Privileged Identity Management (PIM) for time-limited access even for non-privileged roles

## Default Value

By default, there is no automatic review process for role assignments. Organizations must establish their own review procedures.

## References

- [Azure built-in roles](https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles)
- [List Azure role assignments](https://docs.microsoft.com/en-us/azure/role-based-access-control/role-assignments-list-portal)
- [What are Azure AD access reviews?](https://docs.microsoft.com/en-us/azure/active-directory/governance/access-reviews-overview)
- [Best practices for Azure RBAC](https://docs.microsoft.com/en-us/azure/role-based-access-control/best-practices)

