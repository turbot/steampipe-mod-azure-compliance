## Description

Private endpoints should be used to access Azure Databricks workspaces to ensure traffic stays within the Azure backbone network and doesn't traverse the internet.

## Rationale

Azure Private Link enables private connectivity to Azure Databricks workspaces by:
- Creating private endpoints in your VNet
- Assigning private IP addresses from your VNet to the Databricks workspace
- Ensuring all traffic between users and the workspace stays on the Azure private network
- Eliminating exposure to the public internet
- Enabling connectivity from on-premises networks via ExpressRoute or VPN
- Providing network isolation and enhanced security

Private endpoints support two connection types:
- **Frontend**: For workspace UI and REST API access
- **Backend**: For web authentication and secure cluster connectivity

Using private endpoints ensures that Databricks workspace access is secured through private IP addresses and doesn't rely on public internet connectivity.

## Audit

**From Azure Portal:**

1. Go to `Azure Databricks`
2. Select the workspace
3. Under `Networking`, click `Private endpoint connections`
4. Verify that private endpoints are configured and approved
5. Ensure at least two private endpoints exist:
   - One for `databricks_ui_api` (frontend)
   - One for `browser_authentication` (backend)
6. Check the `Connection state` is `Approved`

**From Azure CLI:**

```bash
# List private endpoints for the workspace
az network private-endpoint list \
  --query "[?privateLinkServiceConnections[?privateLinkServiceId==<workspace-resource-id>]]" \
  --output table

# Check workspace private endpoint connections
az databricks workspace show \
  --name <workspace-name> \
  --resource-group <resource-group-name> \
  --query "privateEndpointConnections"
```

## Remediation

**Prerequisites:**

1. Azure Databricks Premium tier workspace
2. Virtual network for private endpoint deployment
3. Subnet with sufficient IP addresses
4. Appropriate permissions to create private endpoints

**From Azure Portal:**

**Create Frontend Private Endpoint:**

1. Go to `Azure Databricks`
2. Select the workspace
3. Under `Networking`, click `Private endpoint connections`
4. Click `+ Private endpoint`
5. On the Basics tab:
   - Select subscription and resource group
   - Enter name: `<workspace-name>-frontend-pe`
   - Select region (same as workspace)
6. On the Resource tab:
   - Resource type: `Microsoft.Databricks/workspaces`
   - Resource: Select your workspace
   - Target sub-resource: `databricks_ui_api`
7. On the Virtual Network tab:
   - Select your VNet and subnet
   - Optionally configure private DNS integration
8. Review and create

**Create Backend Private Endpoint:**

Repeat the above steps with:
- Name: `<workspace-name>-backend-pe`
- Target sub-resource: `browser_authentication`

**From Azure CLI:**

```bash
# Create frontend private endpoint
az network private-endpoint create \
  --name <workspace-name>-frontend-pe \
  --resource-group <resource-group-name> \
  --vnet-name <vnet-name> \
  --subnet <subnet-name> \
  --private-connection-resource-id <workspace-resource-id> \
  --group-id databricks_ui_api \
  --connection-name frontend-connection

# Create backend private endpoint
az network private-endpoint create \
  --name <workspace-name>-backend-pe \
  --resource-group <resource-group-name> \
  --vnet-name <vnet-name> \
  --subnet <subnet-name> \
  --private-connection-resource-id <workspace-resource-id> \
  --group-id browser_authentication \
  --connection-name backend-connection
```

**Configure Private DNS:**

1. Create Private DNS zone: `privatelink.azuredatabricks.net`
2. Link the zone to your VNet
3. Private endpoint will automatically create DNS records if integration is enabled

**Verify Configuration:**

```bash
# Test DNS resolution
nslookup <workspace-url>

# Should return private IP address from your VNet
```

## References

- [Azure Private Link for Azure Databricks](https://docs.microsoft.com/en-us/azure/databricks/administration-guide/cloud-configurations/azure/private-link)
- [Create a private endpoint](https://docs.microsoft.com/en-us/azure/private-link/create-private-endpoint-portal)
- [Private Link architecture](https://docs.microsoft.com/en-us/azure/databricks/security/network/classic/private-link-standard)

