## Description

This recommendation ensures that issued tokens are only issued to the intended device.

## Rationale

Token Protection is a security feature in Conditional Access that binds tokens to the device on which the user authenticated. This prevents token theft and replay attacks where an attacker steals a token from one device and uses it on another.

Token Protection works by:
- Binding the issued token cryptographically to the device
- Verifying the token is being used from the same device it was issued to
- Blocking token use if device validation fails

This is particularly important for:
- High-value targets like administrators
- Access to sensitive applications
- Compliance requirements for device-bound credentials
- Protection against token theft malware

**Note:** Token Protection requires compatible devices (Windows 10/11 with TPM 2.0, or devices enrolled in Microsoft Intune/Endpoint Manager).

## Audit

**From Azure Portal:**

1. From Azure Home open the portal menu in the top left, and select `Microsoft Entra ID`
2. Select `Security`
3. Select `Conditional Access`
4. Review policies to identify one that enforces Token Protection
5. For such a policy, verify:
   - **Assignments > Users**: Should include `All users` or administrative roles
   - **Assignments > Cloud apps or actions**: Should include appropriate apps
   - **Access controls > Session**:
     - Select `Use Conditional Access App Control`
     - Or select custom session controls if available
   - **Enable policy**: Should be `On`

**Note:** Token Protection is a relatively new feature, and the exact configuration may vary depending on when it becomes generally available.

**From PowerShell:**

```powershell
Connect-AzureAD
$policies = Get-AzureADMSConditionalAccessPolicy
foreach ($policy in $policies) {
    if ($policy.SessionControls.SignInFrequency -ne $null) {
        Write-Host "Policy with session controls found: $($policy.DisplayName)"
        Write-Host "Policy State: $($policy.State)"
    }
}
```

## Remediation

**From Azure Portal:**

Token Protection setup depends on the current Microsoft Entra ID capabilities. As this is an emerging feature, the exact steps may vary. General guidance:

1. **Ensure device compliance:**
   - Enroll devices in Microsoft Intune/Endpoint Manager
   - Ensure devices have TPM 2.0 (for Windows)
   - Deploy required updates to support Token Protection

2. **Create Conditional Access policy:**
   - From Azure Home open the portal menu in the top left, and select `Microsoft Entra ID`
   - Select `Security`
   - Select `Conditional Access`
   - Click `+ New policy`
   - Enter a name for the policy (e.g., "Require Token Protection")

3. **Configure assignments:**
   - **Users**: Include administrative roles or all users
   - **Cloud apps or actions**: Select apps that require Token Protection
   - **Conditions > Filter for devices**: Configure to include compliant/managed devices

4. **Configure session controls:**
   - Under **Access controls > Session**
   - Enable appropriate token binding controls when available
   - Configure sign-in frequency if needed to limit token lifetime

5. **Test and enable:**
   - Set **Enable policy** to `Report-only` initially
   - Monitor and validate functionality
   - Set **Enable policy** to `On`

**Alternative Approach - Use sign-in frequency:**

While full Token Protection is being rolled out, you can reduce token lifetime:

1. Under **Access controls > Session**:
   - Check `Sign-in frequency`
   - Set to `Every time` or a short duration (e.g., 1 hour)
   - This forces re-authentication more frequently, reducing token replay window

**Important Notes:**
- Token Protection requires modern, managed devices
- Test with a pilot group first
- May impact user experience with additional authentication prompts
- Not all applications may support Token Protection initially

## Default Value

By default, tokens are not bound to devices and Token Protection is not enabled.

## References

- [What is Conditional Access in Azure Active Directory?](https://docs.microsoft.com/en-us/azure/active-directory/conditional-access/overview)
- [Conditional Access: Session](https://docs.microsoft.com/en-us/azure/active-directory/conditional-access/concept-conditional-access-session)
- [Configure authentication session management](https://docs.microsoft.com/en-us/azure/active-directory/conditional-access/howto-conditional-access-session-lifetime)

