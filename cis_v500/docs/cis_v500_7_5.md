## Description

Network security group flow logs should be enabled and the retention period set to greater than or equal to 90 days.

## Rationale

Network Security Group (NSG) flow logs are a feature of Azure Network Watcher that allows you to log information about IP traffic flowing through an NSG. Flow logs are critical for:

**Security monitoring and incident response:**
- **Attack detection**: Identify suspicious traffic patterns and potential attacks
- **Forensic analysis**: Investigate security incidents with historical traffic data
- **Threat hunting**: Proactively search for indicators of compromise
- **Incident response**: Understand the scope and timeline of security breaches
- **Compliance investigations**: Provide evidence for compliance and audit requirements

**Network troubleshooting:**
- Diagnose connectivity issues
- Identify network bottlenecks
- Validate NSG rule effectiveness
- Monitor traffic flows between subnets and resources
- Troubleshoot application connectivity problems

**Operational insights:**
- Understand traffic patterns
- Capacity planning based on actual usage
- Identify unused resources
- Optimize network configuration
- Monitor for network anomalies

**Why 90 days retention minimum:**

**Security and compliance:**
- **Breach detection window**: Many breaches go undetected for weeks or months
- **Forensic analysis**: Investigations often require historical data spanning months
- **Compliance requirements**: Many regulations require 90+ days of log retention:
  - PCI DSS: 3 months minimum, 1 year recommended
  - HIPAA: Typically requires 6 years
  - SOC 2: Often requires 90 days minimum
  - GDPR: Varies by implementation but often 90+ days
- **Attack pattern analysis**: Understanding sophisticated attacks requires longer timeframes
- **Legal hold**: Litigation may require extended historical data

**Incident response:**
- Attacks may be discovered long after they occur
- Understanding the full timeline requires historical data
- Correlation with other security events over time
- Tracking persistence mechanisms and backdoors

**Trend analysis:**
- Identify long-term patterns
- Seasonal traffic variations
- Gradual changes that indicate compromise
- Baseline establishment requires extended periods

**Cost considerations:**
NSG flow logs do incur storage costs, but the security and operational benefits typically outweigh the expense. Costs can be managed through:
- Traffic Analytics for aggregated insights
- Archiving older logs to cheaper storage tiers
- Selective enablement on critical NSGs
- Data lifecycle management policies

## Audit

**From Azure Portal:**

1. From Azure Home, search for `Network Watcher`
2. Select `NSG flow logs` under Logs
3. Review the list of NSG flow logs
4. For each NSG:
   - Check if flow logging is enabled
   - Verify retention period is â‰¥ 90 days
   - Confirm logs are being written to storage account
5. Identify any NSGs without flow logging enabled

**From Azure CLI:**

```bash
# List all NSGs
az network nsg list --query "[].{Name:name, ResourceGroup:resourceGroup, Location:location}" -o table

# For each NSG, check flow log configuration
az network watcher flow-log show \
  --nsg <nsg-name> \
  --resource-group <resource-group-name> \
  --query "{Enabled:enabled, RetentionDays:retentionPolicy.days, StorageAccount:storageId}" -o table
```

**From PowerShell:**

```powershell
Connect-AzAccount

# Get all NSGs
$nsgs = Get-AzNetworkSecurityGroup

foreach ($nsg in $nsgs) {
    # Get flow log configuration
    $flowLog = Get-AzNetworkWatcherFlowLog | Where-Object {$_.TargetResourceId -eq $nsg.Id}

    if ($flowLog) {
        $retentionDays = $flowLog.RetentionPolicy.Days
        if ($retentionDays -lt 90) {
            Write-Host "WARNING: NSG '$($nsg.Name)' has retention < 90 days: $retentionDays days" -ForegroundColor Red
        } else {
            Write-Host "OK: NSG '$($nsg.Name)' retention: $retentionDays days" -ForegroundColor Green
        }
    } else {
        Write-Host "WARNING: NSG '$($nsg.Name)' does not have flow logging enabled" -ForegroundColor Red
    }
}
```

## Remediation

**Step 1: Ensure Network Watcher is enabled**

Network Watcher must be enabled in the region before configuring flow logs:

```bash
# Enable Network Watcher
az network watcher configure \
  --resource-group <network-watcher-rg> \
  --locations <region> \
  --enabled true
```

**Step 2: Create or identify storage account**

Flow logs require a storage account:

```bash
# Create storage account for flow logs
az storage account create \
  --name <storage-account-name> \
  --resource-group <resource-group-name> \
  --location <region> \
  --sku Standard_LRS \
  --kind StorageV2
```

**Step 3: Enable NSG flow logs with 90+ days retention**

**From Azure Portal:**

1. From Azure Home, search for `Network Watcher`
2. Select `NSG flow logs` under Logs
3. Click `+ Create` or select existing flow log to modify
4. Configure:
   - Select the NSG
   - Flow logs version: Version 2 (recommended)
   - Storage account: Select or create
   - Retention (days): Set to 90 or higher (0 = unlimited)
   - Traffic Analytics: Enable (recommended)
5. Click `Save`

**From Azure CLI:**

```bash
# Enable NSG flow logs with 90 days retention
az network watcher flow-log create \
  --name <flow-log-name> \
  --nsg <nsg-name> \
  --resource-group <nsg-resource-group> \
  --storage-account <storage-account-id> \
  --location <region> \
  --retention 90 \
  --enabled true \
  --format JSON \
  --log-version 2
```

**Update existing flow log retention:**

```bash
az network watcher flow-log update \
  --name <flow-log-name> \
  --resource-group <resource-group-name> \
  --retention 90
```

**From PowerShell:**

```powershell
# Get Network Watcher
$nw = Get-AzNetworkWatcher -ResourceGroupName <network-watcher-rg> -Name <network-watcher-name>

# Get NSG
$nsg = Get-AzNetworkSecurityGroup -Name <nsg-name> -ResourceGroupName <resource-group-name>

# Get Storage Account
$storageAccount = Get-AzStorageAccount -ResourceGroupName <resource-group-name> -Name <storage-account-name>

# Configure flow log
Set-AzNetworkWatcherFlowLog `
  -NetworkWatcher $nw `
  -TargetResourceId $nsg.Id `
  -StorageAccountId $storageAccount.Id `
  -EnableFlowLog $true `
  -EnableRetention $true `
  -RetentionInDays 90 `
  -FormatType Json `
  -FormatVersion 2
```

**Step 4: Enable Traffic Analytics (Optional but Recommended)**

Traffic Analytics provides additional insights from flow logs:

```bash
# Create Log Analytics workspace
az monitor log-analytics workspace create \
  --resource-group <resource-group-name> \
  --workspace-name <workspace-name>

# Enable Traffic Analytics on flow log
az network watcher flow-log update \
  --name <flow-log-name> \
  --resource-group <resource-group-name> \
  --workspace <workspace-id> \
  --interval 60
```

**Best Practices:**

1. **Enable flow logs on all NSGs**:
   - Especially critical for production environments
   - External-facing NSGs are highest priority
   - Consider all NSGs for comprehensive visibility

2. **Use Flow Logs Version 2**:
   - Additional metadata (flow state, throughput)
   - Better for analysis and troubleshooting
   - Required for Traffic Analytics

3. **Implement Traffic Analytics**:
   - Aggregated insights and visualization
   - Security analytics and anomaly detection
   - Reduce storage costs compared to raw logs
   - Integration with Azure Sentinel

4. **Storage account considerations**:
   - Use dedicated storage account for logs
   - Enable soft delete for recovery
   - Implement lifecycle management to archive old logs
   - Consider cross-region replication for disaster recovery

5. **Retention strategy**:
   - 90 days minimum for compliance
   - 180-365 days for enhanced security
   - Unlimited (0) for long-term forensics (manage with lifecycle policies)
   - Archive to cheaper storage tiers after 90 days

6. **Cost optimization**:
   - Enable Traffic Analytics to reduce need for raw log analysis
   - Use lifecycle management to move logs to cool/archive tiers
   - Consider selective enablement (critical NSGs first)
   - Monitor storage costs regularly

7. **Monitoring and alerts**:
   - Alert on flow log configuration changes
   - Monitor storage account capacity
   - Alert on disabled flow logging
   - Regular review of flow log status

8. **Integration with SIEM**:
   - Export flow logs to Azure Sentinel
   - Integration with third-party SIEM solutions
   - Automated threat detection
   - Correlation with other security logs

9. **Automation**:
   - Use Azure Policy to enforce flow logging
   - Automated remediation for non-compliant NSGs
   - Infrastructure as Code (Terraform, ARM templates)

10. **Access control**:
    - Restrict access to flow log storage accounts
    - Use managed identities where possible
    - Implement RBAC for Network Watcher
    - Audit access to flow logs

## Default Value

By default, NSG flow logs are not enabled. Organizations must manually enable them and configure appropriate retention periods.

## References

- [NSG flow logs overview](https://docs.microsoft.com/en-us/azure/network-watcher/network-watcher-nsg-flow-logging-overview)
- [Introduction to flow logging for NSGs](https://docs.microsoft.com/en-us/azure/network-watcher/network-watcher-nsg-flow-logging-overview)
- [Traffic Analytics](https://docs.microsoft.com/en-us/azure/network-watcher/traffic-analytics)
- [Manage NSG flow logs using Azure Portal](https://docs.microsoft.com/en-us/azure/network-watcher/network-watcher-nsg-flow-logging-portal)
- [Azure Policy for NSG flow logs](https://docs.microsoft.com/en-us/azure/network-watcher/network-watcher-nsg-flow-logging-azure-policy)

