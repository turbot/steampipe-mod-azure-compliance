## Description

Users and groups should be synced from Microsoft Entra ID (formerly Azure Active Directory) to Azure Databricks to maintain consistent identity management.

## Rationale

Synchronizing users and groups from Microsoft Entra ID to Azure Databricks provides:
- Centralized identity management
- Consistent user access across Azure services
- Simplified user provisioning and deprovisioning
- Integration with organizational identity and access management policies
- Support for conditional access and multi-factor authentication
- Automated user lifecycle management

This ensures that user access to Databricks workspaces is controlled through the organization's central identity provider and that access is automatically updated when users join, change roles, or leave the organization.

## Audit

**From Azure Portal:**

1. Go to `Azure Databricks`
2. Click on the workspace
3. Click `Launch Workspace`
4. Go to `Settings` > `Admin Console`
5. Click `User management`
6. Verify that users and groups are synced from Microsoft Entra ID
7. Check for SCIM provisioning configuration under `Settings` > `Identity and access`

**From Azure CLI:**

```bash
# Check if SCIM provisioning is configured
az databricks workspace show \
  --name <workspace-name> \
  --resource-group <resource-group-name> \
  --query "parameters.enableScimProvisioning"
```

**From Microsoft Entra ID:**

1. Go to `Microsoft Entra ID` > `Enterprise applications`
2. Search for your Databricks workspace
3. Go to `Provisioning`
4. Verify that provisioning is configured and status is `On`

## Remediation

**Configure SCIM Provisioning:**

1. In Microsoft Entra ID, go to `Enterprise applications`
2. Click `+ New application`
3. Search for and select `Azure Databricks SCIM Provisioning Connector`
4. Click `Create`
5. Go to `Provisioning` and click `Get started`
6. Set `Provisioning Mode` to `Automatic`
7. In `Admin Credentials`:
   - Set `Tenant URL` to your Databricks workspace SCIM endpoint
   - Generate and enter a `Secret Token` from Databricks
8. Click `Test Connection` to validate
9. Configure `Mappings` for users and groups
10. Set `Provisioning Status` to `On`
11. Click `Save`

**Generate Databricks Token:**

1. In Databricks workspace, go to `Settings` > `Admin Console`
2. Click `User management` > `Service principals`
3. Create a service principal with admin permissions
4. Generate a personal access token for the service principal
5. Use this token in the Microsoft Entra ID SCIM configuration

## References

- [Sync users and groups from Microsoft Entra ID](https://docs.microsoft.com/en-us/azure/databricks/administration-guide/users-groups/scim/aad)
- [Configure SCIM provisioning](https://docs.microsoft.com/en-us/azure/databricks/administration-guide/users-groups/scim/)
- [Microsoft Entra ID user provisioning](https://docs.microsoft.com/en-us/azure/active-directory/app-provisioning/user-provisioning)

