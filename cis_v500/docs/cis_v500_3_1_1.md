## Description

Ensure that only identities with multi-factor authentication (MFA) enabled can access privileged virtual machines to prevent unauthorized access.

## Rationale

Privileged virtual machines often contain sensitive data or provide access to critical infrastructure. Requiring MFA for access to these VMs provides:
- Additional layer of security beyond passwords
- Protection against credential theft and phishing attacks
- Reduced risk of unauthorized access from compromised credentials
- Compliance with security best practices and regulatory requirements
- Defense-in-depth security posture

Multi-factor authentication significantly reduces the risk of unauthorized access even if passwords are compromised, as attackers would also need access to the second authentication factor.

## Audit

**Identify Privileged Virtual Machines:**

First, identify which VMs are considered privileged based on your organization's criteria:
- VMs with administrative access to other resources
- VMs handling sensitive or regulated data
- VMs in production environments with business-critical workloads
- Jump boxes or bastion hosts
- Domain controllers

**From Microsoft Entra ID (Azure Portal):**

1. Go to `Microsoft Entra ID`
2. Navigate to `Security` > `Conditional Access`
3. Review existing policies
4. Verify that policies requiring MFA are applied to:
   - Users or groups with privileged VM access
   - Applications or resources that control VM access
5. Check `Sign-in logs` to verify MFA usage:
   - Go to `Sign-in logs`
   - Filter for users with VM access
   - Check the `Authentication details` column for MFA requirements

**Check User MFA Status:**

1. Go to `Microsoft Entra ID` > `Users`
2. Select `Multi-Factor Authentication` from the top menu
3. Review the MFA status for users with privileged VM access
4. Verify status is `Enabled` or `Enforced`

**From Azure CLI:**

```bash
# Check conditional access policies
az rest --method GET \
  --uri 'https://graph.microsoft.com/v1.0/identity/conditionalAccess/policies' \
  --query "value[?state=='enabled']" \
  --output table

# Check specific policy details
az rest --method GET \
  --uri 'https://graph.microsoft.com/v1.0/identity/conditionalAccess/policies/{policy-id}'
```

**Verify VM Access Controls:**

```bash
# List role assignments for a VM
az role assignment list \
  --scope /subscriptions/{subscription-id}/resourceGroups/{rg}/providers/Microsoft.Compute/virtualMachines/{vm-name} \
  --output table

# Check for privileged roles like Owner, Contributor, Virtual Machine Administrator Login
```

## Remediation

**Step 1: Identify Privileged Users and Groups**

1. Determine which users and groups require access to privileged VMs
2. Create a dedicated group for privileged VM administrators if not already exists:
   - Go to `Microsoft Entra ID` > `Groups`
   - Create a new security group (e.g., "Privileged-VM-Admins")
   - Add appropriate users

**Step 2: Configure Conditional Access Policy**

1. Go to `Microsoft Entra ID` > `Security` > `Conditional Access`
2. Click `+ New policy`
3. Configure the policy:
   - **Name**: "Require MFA for Privileged VM Access"
   - **Assignments**:
     - **Users**: Select the privileged users/groups identified
     - **Cloud apps or actions**:
       - Select `Select apps`
       - Include: `Azure Virtual Desktop`, `Azure Portal`, or specific applications
     - **Conditions**: Configure as needed (e.g., specific locations)
   - **Access controls**:
     - **Grant**: Select `Grant access`
     - Check `Require multi-factor authentication`
     - **For multiple controls**: Select `Require all the selected controls`
4. Set `Enable policy` to `On`
5. Click `Create`

**Step 3: Enable MFA for Users**

For Per-User MFA (if not using Conditional Access):

1. Go to `Microsoft Entra ID` > `Users`
2. Click `Multi-Factor Authentication`
3. Select users who need MFA
4. Click `Enable` in the quick steps
5. Confirm the action

**Step 4: Configure Azure RBAC**

Ensure only MFA-enabled users have privileged roles on VMs:

```bash
# Assign role to MFA-enabled group
az role assignment create \
  --assignee <group-object-id> \
  --role "Virtual Machine Administrator Login" \
  --scope /subscriptions/{subscription-id}/resourceGroups/{rg}/providers/Microsoft.Compute/virtualMachines/{vm-name}
```

**Step 5: Verify and Test**

1. Test access with an MFA-enabled user
2. Verify MFA prompt appears when accessing privileged VMs
3. Check sign-in logs to confirm MFA is being enforced
4. Document the policy and communicate to affected users

**From PowerShell:**

```powershell
# Create Conditional Access Policy using Microsoft Graph PowerShell
Connect-MgGraph -Scopes "Policy.ReadWrite.ConditionalAccess"

$conditions = @{
    Users = @{
        IncludeGroups = @("<privileged-vm-group-id>")
    }
    Applications = @{
        IncludeApplications = @("All")
    }
}

$controls = @{
    GrantControls = @{
        BuiltInControls = @("mfa")
        Operator = "AND"
    }
}

New-MgIdentityConditionalAccessPolicy `
    -DisplayName "Require MFA for Privileged VM Access" `
    -State "enabled" `
    -Conditions $conditions `
    -GrantControls $controls
```

## Additional Considerations

1. **Just-in-Time (JIT) Access**: Consider implementing Azure Defender for Cloud's JIT VM access for additional protection
2. **Privileged Identity Management (PIM)**: Use Azure AD PIM to require MFA for elevated role activations
3. **Azure Bastion**: Use Azure Bastion for secure RDP/SSH access without public IP exposure
4. **Monitoring**: Enable Azure Monitor and Azure Sentinel to track VM access and MFA compliance
5. **Break-glass Accounts**: Maintain emergency access procedures with appropriate MFA controls

## References

- [Conditional Access: Require MFA](https://docs.microsoft.com/en-us/azure/active-directory/conditional-access/howto-conditional-access-policy-all-users-mfa)
- [Enable Multi-Factor Authentication in Azure AD](https://docs.microsoft.com/en-us/azure/active-directory/authentication/howto-mfa-getstarted)
- [Azure AD Conditional Access](https://docs.microsoft.com/en-us/azure/active-directory/conditional-access/overview)
- [Just-in-Time VM access](https://docs.microsoft.com/en-us/azure/defender-for-cloud/just-in-time-access-usage)
- [Azure Bastion](https://docs.microsoft.com/en-us/azure/bastion/bastion-overview)

