## Description

Microsoft Entra ID has native and extended identity functionality allowing you to invite people from outside your organization to be guest users in your cloud account and sign in with their own work, school, or social identities.

## Rationale

Guest users are external users who have been granted access to resources in your Microsoft Entra ID tenant. While guest access can be necessary for collaboration, it also introduces security risks:
- Guest users may have access to sensitive information
- Compromised guest accounts can be used to access your organization's resources
- Guest users may belong to organizations with different security standards
- Over time, guest accounts may accumulate and become stale

Regular reviews of guest user accounts help to:
- Identify and remove guest users who no longer need access
- Ensure guest users have appropriate permissions
- Maintain compliance with data protection and privacy regulations
- Reduce the attack surface by removing unnecessary external access

Organizations should conduct regular reviews (at least quarterly, preferably monthly) of all guest user accounts.

## Audit

**From Azure Portal:**

1. From Azure Home open the portal menu in the top left, and select `Microsoft Entra ID`
2. Select `Users`
3. Click on `Add filters`
4. Select `User type` and filter by `Guest`
5. Review the list of guest users:
   - Check when they were created
   - Verify their last sign-in date
   - Confirm if they still require access
   - Review what resources they have access to

**From PowerShell:**

```powershell
Connect-AzureAD
$guestUsers = Get-AzureADUser -Filter "userType eq 'Guest'" -All $true
foreach ($guest in $guestUsers) {
    $signInActivity = Get-AzureADAuditSignInLogs -Filter "userPrincipalName eq '$($guest.UserPrincipalName)'" -Top 1
    Write-Host "Guest User: $($guest.UserPrincipalName)"
    Write-Host "Created: $($guest.CreatedDateTime)"
    Write-Host "Last Sign-In: $($signInActivity.CreatedDateTime)"
    Write-Host "------------------------"
}
```

**From Azure CLI:**

```bash
az ad user list --filter "userType eq 'Guest'" --query "[].{UPN:userPrincipalName, Created:createdDateTime, DisplayName:displayName}" -o table
```

## Remediation

**Establish a Regular Review Process:**

1. **Create a review schedule:**
   - Set up monthly or quarterly reviews of guest users
   - Assign responsibility for conducting reviews to a specific team or individual
   - Document the review process and criteria for removal

2. **Review guest users:**
   - Identify guest users who have not signed in for 90 days or more
   - Contact sponsoring employees to verify if guest access is still needed
   - Check if guest users still belong to the partner organizations they represent
   - Verify that guest users have only the minimum necessary permissions

3. **Remove unnecessary guest access:**

   **From Azure Portal:**
   - From Azure Home open the portal menu in the top left, and select `Microsoft Entra ID`
   - Select `Users`
   - Filter by User type = `Guest`
   - Select guest users that should be removed
   - Click `Delete user`

   **From PowerShell:**
   ```powershell
   Connect-AzureAD
   # Remove a specific guest user
   Remove-AzureADUser -ObjectId <guest-user-object-id>
   ```

   **From Azure CLI:**
   ```bash
   az ad user delete --id <guest-user-upn>
   ```

4. **Implement Azure AD Access Reviews (Recommended):**

   **From Azure Portal (Requires Azure AD Premium P2):**
   - From Azure Home open the portal menu in the top left, and select `Microsoft Entra ID`
   - Select `Identity Governance`
   - Select `Access reviews`
   - Click `+ New access review`
   - Configure:
     - Review name: "Guest User Access Review"
     - Users: Select "Guest users only"
     - Scope: All users
     - Group: Select relevant groups or all groups
     - Reviewers: Manager, self-review, or specific reviewers
     - Recurrence: Monthly or Quarterly
   - Click `Start`

## Default Value

By default, there is no automatic review process for guest users. Organizations must manually review or set up automated access reviews.

## References

- [What is guest user access in Azure Active Directory B2B?](https://docs.microsoft.com/en-us/azure/active-directory/external-identities/what-is-b2b)
- [Auditing and reporting a B2B collaboration user](https://docs.microsoft.com/en-us/azure/active-directory/external-identities/auditing-and-reporting)
- [What are Azure AD access reviews?](https://docs.microsoft.com/en-us/azure/active-directory/governance/access-reviews-overview)

