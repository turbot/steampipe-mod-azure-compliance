## Description

Network security groups (NSGs) should be configured for Databricks subnets to control inbound and outbound network traffic.

## Rationale

Network Security Groups provide stateful packet filtering capabilities that help control network traffic to and from Azure Databricks clusters. Configuring NSGs for Databricks subnets:
- Controls inbound and outbound traffic to cluster nodes
- Prevents unauthorized access to Databricks resources
- Enables compliance with security policies
- Provides defense-in-depth security

When using VNet injection, proper NSG configuration is critical to ensure that Databricks clusters can communicate with Azure services while preventing unauthorized access.

## Audit

**From Azure Portal:**

1. Go to `Azure Databricks`
2. For each workspace, click on the workspace name
3. Under `Networking`, note the VNet and subnets used
4. Go to `Virtual Networks`
5. Select the VNet used by Databricks
6. Under `Subnets`, check both the public and private subnets
7. Verify that each subnet has an NSG attached

**From Azure CLI:**

```bash
# Get workspace subnet information
az databricks workspace show --name <workspace-name> --resource-group <resource-group-name>

# Check NSG for each subnet
az network vnet subnet show --vnet-name <vnet-name> --name <subnet-name> --resource-group <resource-group-name> --query "networkSecurityGroup"
```

## Remediation

**From Azure Portal:**

1. Go to `Network security groups`
2. Create or select an NSG
3. Configure required inbound and outbound rules for Databricks
4. Go to `Virtual Networks`
5. Select the VNet containing Databricks subnets
6. Under `Subnets`, select the Databricks subnet
7. Under `Network security group`, select the configured NSG
8. Click `Save`
9. Repeat for all Databricks subnets

**From Azure CLI:**

```bash
# Associate NSG with subnet
az network vnet subnet update \
  --vnet-name <vnet-name> \
  --name <subnet-name> \
  --resource-group <resource-group-name> \
  --network-security-group <nsg-name>
```

## References

- [Secure cluster connectivity](https://docs.microsoft.com/en-us/azure/databricks/security/network/secure-cluster-connectivity)
- [Network security groups](https://docs.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview)

