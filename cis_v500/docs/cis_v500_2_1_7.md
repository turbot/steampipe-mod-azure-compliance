## Description

Diagnostic log delivery should be configured for Azure Databricks to enable monitoring, auditing, and security analysis of workspace activities.

## Rationale

Diagnostic logging for Azure Databricks captures important security and operational events:
- User authentication and access events
- Workspace configuration changes
- Cluster creation and termination
- Notebook and job executions
- Secret access and management
- SQL query execution

Enabling diagnostic logging provides:
- Security monitoring and threat detection
- Compliance audit trails
- Operational troubleshooting capabilities
- Historical analysis of workspace activities
- Integration with SIEM tools for security analysis

Logs can be sent to Azure Monitor Logs, Azure Storage, or Azure Event Hubs for analysis and retention.

## Audit

**From Azure Portal:**

1. Go to `Azure Databricks`
2. Select the workspace
3. Under `Monitoring`, click `Diagnostic settings`
4. Verify that at least one diagnostic setting is configured
5. Ensure the following log categories are enabled:
   - `dbfs`
   - `clusters`
   - `accounts`
   - `jobs`
   - `notebook`
   - `ssh`
   - `workspace`
   - `secrets`
   - `sqlPermissions`
   - `instancePools`

**From Azure CLI:**

```bash
az monitor diagnostic-settings list \
  --resource <workspace-resource-id> \
  --query "value[].{Name:name, Logs:logs[?enabled].category}" \
  --output table
```

## Remediation

**From Azure Portal:**

1. Go to `Azure Databricks`
2. Select the workspace
3. Under `Monitoring`, click `Diagnostic settings`
4. Click `+ Add diagnostic setting`
5. Enter a name for the setting
6. Select all relevant log categories:
   - `dbfs`
   - `clusters`
   - `accounts`
   - `jobs`
   - `notebook`
   - `ssh`
   - `workspace`
   - `secrets`
   - `sqlPermissions`
   - `instancePools`
7. Choose destination(s):
   - `Send to Log Analytics workspace` (recommended)
   - `Archive to a storage account` (for long-term retention)
   - `Stream to an event hub` (for SIEM integration)
8. Click `Save`

**From Azure CLI:**

```bash
az monitor diagnostic-settings create \
  --name <setting-name> \
  --resource <workspace-resource-id> \
  --workspace <log-analytics-workspace-id> \
  --logs '[
    {"category": "dbfs", "enabled": true},
    {"category": "clusters", "enabled": true},
    {"category": "accounts", "enabled": true},
    {"category": "jobs", "enabled": true},
    {"category": "notebook", "enabled": true},
    {"category": "ssh", "enabled": true},
    {"category": "workspace", "enabled": true},
    {"category": "secrets", "enabled": true},
    {"category": "sqlPermissions", "enabled": true},
    {"category": "instancePools", "enabled": true}
  ]'
```

## References

- [Monitor Azure Databricks](https://docs.microsoft.com/en-us/azure/databricks/administration-guide/account-settings/azure-diagnostic-logs)
- [Diagnostic settings in Azure Monitor](https://docs.microsoft.com/en-us/azure/azure-monitor/essentials/diagnostic-settings)

