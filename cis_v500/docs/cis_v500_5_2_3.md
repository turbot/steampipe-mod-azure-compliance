## Description

Conditional Access Policies can be used to prevent the Device code authentication flow. Device code flow should be permitted only for users that regularly perform duties that explicitly require the use of Device Code to authenticate, such as utilizing Azure with PowerShell.

## Rationale

The device code flow is a type of authentication flow that allows users to sign in to devices that don't have a web browser or that have input constraints. The user is shown a code on the device and then uses a different device (like a smartphone or laptop) to navigate to a website where they enter the code and complete authentication.

While convenient, this authentication method has security risks:
- The code could be intercepted by an attacker
- Users might be tricked into entering the code on a malicious site (phishing)
- The code is displayed in plain text and could be shoulder-surfed

Organizations should restrict device code flow authentication to only those users who absolutely need it for their role (such as engineers using Azure CLI or PowerShell in automated scenarios).

## Audit

**From Azure Portal:**

1. From Azure Home open the portal menu in the top left, and select `Microsoft Entra ID`
2. Select `Security`
3. Select `Conditional Access`
4. Review policies to identify if a device code flow blocking policy exists
5. For a policy that blocks device code flow, verify:
   - **Assignments > Users**: Should include `All users` or exclude only users who require device code flow
   - **Assignments > Cloud apps or actions**: Select `All cloud apps`
   - **Conditions > Client apps**: Configure should be `Yes`, and `Mobile apps and desktop clients` should be selected
   - **Conditions > Authentication flows**: Should be configured and `Device code flow` should be selected
   - **Access controls > Grant**: Should be set to `Block access`
   - **Enable policy**: Should be `On`

**From PowerShell:**

```powershell
Connect-AzureAD
$policies = Get-AzureADMSConditionalAccessPolicy
foreach ($policy in $policies) {
    if ($policy.Conditions.ClientAppTypes -contains "mobileAppsAndDesktopClients" -and
        $policy.GrantControls.BuiltInControls -contains "Block") {
        Write-Host "Device code flow blocking policy found: $($policy.DisplayName)"
    }
}
```

## Remediation

**From Azure Portal:**

1. From Azure Home open the portal menu in the top left, and select `Microsoft Entra ID`
2. Select `Security`
3. Select `Conditional Access`
4. Click `+ New policy`
5. Enter a name for the policy (e.g., "Block Device Code Flow")
6. Under **Assignments**:
   - **Users**:
     - Include: `All users`
     - Exclude: Select a group of users who require device code flow (if any)
   - **Cloud apps or actions**: Select `All cloud apps`
   - **Conditions > Client apps**:
     - Configure: `Yes`
     - Select `Mobile apps and desktop clients`
   - **Conditions > Filter for devices**:
     - Configure: `Yes`
     - Select `Include filtered devices in policy` or `Exclude filtered devices from policy` as appropriate
7. Under **Conditions > Authentication flows (Preview)**:
   - Configure: `Yes`
   - Select `Device code flow`
8. Under **Access controls > Grant**:
   - Select `Block access`
9. Set **Enable policy** to `Report-only` initially to test
10. After validating, set **Enable policy** to `On`
11. Click `Create`

**Important Notes:**
- Test in Report-only mode first to identify affected users
- Create a group for users who need device code flow and exclude them from the policy
- Monitor sign-in logs after implementation

## Default Value

By default, device code flow authentication is permitted for all users.

## References

- [Microsoft identity platform and the OAuth 2.0 device authorization grant flow](https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-device-code)
- [Conditional Access: Filter for devices](https://docs.microsoft.com/en-us/azure/active-directory/conditional-access/concept-condition-filters-for-devices)
- [Block legacy authentication with Azure AD Conditional Access](https://docs.microsoft.com/en-us/azure/active-directory/conditional-access/block-legacy-authentication)

