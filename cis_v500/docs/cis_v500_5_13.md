## Description

Allow users to provide consent for selected permissions when a request is coming from a verified publisher.

## Rationale

While recommendation 5.12 suggests disabling all user consent to maximize security, some organizations may find this too restrictive and prefer a balanced approach. This recommendation provides a middle ground that:

**Enables productivity while maintaining security:**
- Users can consent to low-risk applications from verified publishers
- Reduces administrative burden compared to requiring admin consent for all apps
- Maintains user productivity by allowing access to well-known, trusted applications
- Balances security with business needs

**Publisher verification benefits:**
- Publisher verification confirms the app publisher's identity using a Microsoft Partner Network (MPN) account
- Verified publishers have gone through Microsoft's vetting process
- Provides assurance about the legitimacy of the application
- Reduces risk of malicious applications

**Selected permissions approach:**
- Allows consent only for specific, low-risk permissions (configured by admin)
- High-risk permissions still require admin approval
- Administrators define what permissions are "acceptable" for user consent
- Provides granular control over data access

**When to use this approach:**
- Organizations with mature identity governance
- Environments where user productivity is critical
- When admin consent workflow creates bottlenecks
- Organizations comfortable managing some level of third-party app risk
- Teams that need quick access to verified productivity tools

**Risk considerations:**
- Still allows some level of third-party access without admin review
- Publisher verification doesn't guarantee application security
- Users may not fully understand permission implications
- Requires ongoing monitoring of consented applications

This is a CIS Level 2 recommendation (vs Level 1 for recommendation 5.12), indicating it's for organizations with advanced security requirements but needing operational flexibility.

## Audit

**From Azure Portal:**

1. From Azure Home open the portal menu in the top left, and select `Microsoft Entra ID`
2. Select `Enterprise applications`
3. Select `Consent and permissions`
4. Select `User consent settings`
5. Check that `User consent for applications` is set to:
   - `Allow user consent for apps from verified publishers, for selected permissions`
6. Review the `Permission classifications` to see which permissions are considered low-risk

**From PowerShell:**

```powershell
Connect-AzureAD
$policy = Get-AzureADMSAuthorizationPolicy
Write-Host "Permission grant policies: $($policy.PermissionGrantPolicyIdsAssignedToDefaultUserRole)"
```

Should include `microsoft-user-default-low` or similar policy that allows consent for verified publishers with selected permissions.

## Remediation

**From Azure Portal:**

1. From Azure Home open the portal menu in the top left, and select `Microsoft Entra ID`
2. Select `Enterprise applications`
3. Select `Consent and permissions`
4. Select `User consent settings`
5. Under `User consent for applications`, select:
   - `Allow user consent for apps from verified publishers, for selected permissions`
6. Review and configure `Permission classifications`:
   - Click `Permission classifications`
   - Review which permissions are classified as "Low risk"
   - Customize classifications if needed based on your organization's risk tolerance
7. Click `Save`

**Configure Permission Classifications:**

1. In `Permission classifications`, you can customize which permissions are low-risk:
   - `User.Read` - Read signed-in user's profile (typically low-risk)
   - `openid` - Sign users in (typically low-risk)
   - `email` - View user's email address (typically low-risk)
   - `profile` - View basic profile (typically low-risk)

2. High-risk permissions that should require admin consent include:
   - `Mail.Read` - Read all user mail
   - `Files.Read.All` - Read all files
   - `Directory.ReadWrite.All` - Read and write directory data
   - Any `*.All` permissions
   - Application permissions (vs. delegated)

**From PowerShell:**

```powershell
Connect-AzureAD
$policy = Get-AzureADMSAuthorizationPolicy

# Enable consent for verified publishers with low-risk permissions
$policy.PermissionGrantPolicyIdsAssignedToDefaultUserRole = @("microsoft-user-default-low")
Set-AzureADMSAuthorizationPolicy -Id $policy.Id -PermissionGrantPolicyIdsAssignedToDefaultUserRole $policy.PermissionGrantPolicyIdsAssignedToDefaultUserRole
```

**From Microsoft Graph API:**

```bash
az rest --method PATCH \
  --uri "https://graph.microsoft.com/v1.0/policies/authorizationPolicy/authorizationPolicy" \
  --headers "Content-Type=application/json" \
  --body '{"defaultUserRolePermissions":{"permissionGrantPoliciesAssigned":["microsoft-user-default-low"]}}'
```

**Best Practices:**

1. **Enable Admin Consent Workflow:**
   - Configure workflow for permissions that exceed low-risk threshold
   - Users can still request access to apps that need higher permissions
   - Provides a managed escalation path

2. **Regular monitoring:**
   - Review applications that users have consented to
   - Monitor for applications that should be blocked
   - Check for changes in application permissions after initial consent
   - Audit publisher verification status periodically

3. **Permission classification review:**
   - Regularly review which permissions are classified as low-risk
   - Adjust classifications based on your organization's data sensitivity
   - Consider your specific compliance requirements
   - Document decisions about permission risk levels

4. **User education:**
   - Train users on what publisher verification means
   - Teach users to recognize legitimate consent requests
   - Warn about consent phishing attacks
   - Provide guidance on when to request admin consent

5. **Application governance:**
   - Use Microsoft Defender for Cloud Apps or similar tools
   - Monitor OAuth app usage and anomalies
   - Set up alerts for high-risk consent grants
   - Implement app governance policies

6. **Publisher verification validation:**
   - Understand that verification confirms identity, not security
   - Still review the specific permissions requested
   - Check if the app aligns with business needs
   - Investigate unfamiliar verified publishers

## Default Value

By default, user consent settings vary by tenant. Organizations should explicitly configure this setting based on their security posture and operational needs.

## References

- [Configure how users consent to applications](https://docs.microsoft.com/en-us/azure/active-directory/manage-apps/configure-user-consent)
- [Publisher verification](https://docs.microsoft.com/en-us/azure/active-directory/develop/publisher-verification-overview)
- [Risk-based step-up consent](https://docs.microsoft.com/en-us/azure/active-directory/manage-apps/configure-risk-based-step-up-consent)
- [Permissions and consent in the Microsoft identity platform](https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-permissions-and-consent)

