## Description

This recommendation ensures that users accessing the Windows Azure Service Management API (i.e. Azure PowerShell, Azure CLI, Azure Resource Manager API, etc.) are required to use multi-factor authentication (MFA) credentials when accessing resources through the Windows Azure Service Management API.

## Rationale

The Windows Azure Service Management API provides programmatic access to much of the functionality available through the Azure portal. This includes the ability to create, modify, and delete Azure resources, making it a powerful tool that could be abused if compromised.

Requiring MFA for access to the Service Management API adds an extra layer of security to prevent unauthorized access, even if a user's password is compromised. This is especially important for:
- Administrators who use PowerShell or CLI for management tasks
- Developers using REST APIs to interact with Azure
- Automated tools and scripts that authenticate as user principals

## Audit

**From Azure Portal:**

1. From Azure Home open the portal menu in the top left, and select `Microsoft Entra ID`
2. Select `Security`
3. Select `Conditional Access`
4. Review policies to identify one that requires MFA for the Windows Azure Service Management API
5. For such a policy, verify:
   - **Assignments > Users**: Should include `All users` or appropriate administrative groups
   - **Assignments > Cloud apps or actions**:
     - Select `Select apps`
     - Search for and select `Windows Azure Service Management API`
   - **Access controls > Grant**:
     - `Grant access` should be selected
     - `Require multi-factor authentication` should be checked
   - **Enable policy**: Should be `On`

**From PowerShell:**

```powershell
Connect-AzureAD
$targetAppId = "797f4846-ba00-4fd7-ba43-dac1f8f63013" # Windows Azure Service Management API
$policies = Get-AzureADMSConditionalAccessPolicy
foreach ($policy in $policies) {
    if ($policy.Conditions.Applications.IncludeApplications -contains $targetAppId -and
        $policy.GrantControls.BuiltInControls -contains "mfa") {
        Write-Host "MFA policy for Azure Service Management API found: $($policy.DisplayName)"
        Write-Host "Policy State: $($policy.State)"
    }
}
```

## Remediation

**From Azure Portal:**

1. From Azure Home open the portal menu in the top left, and select `Microsoft Entra ID`
2. Select `Security`
3. Select `Conditional Access`
4. Click `+ New policy`
5. Enter a name for the policy (e.g., "Require MFA for Azure Management")
6. Under **Assignments**:
   - **Users**:
     - Include: `All users` or select specific admin groups
     - Exclude: Emergency access accounts if needed
   - **Cloud apps or actions**:
     - Select `Select apps`
     - Click `Select`
     - Search for `Windows Azure Service Management API`
     - Select the application
     - Click `Select`
7. Under **Access controls > Grant**:
   - Select `Grant access`
   - Check `Require multi-factor authentication`
8. Set **Enable policy** to `Report-only` initially to test
9. After validating, set **Enable policy** to `On`
10. Click `Create`

**Important Notes:**
- Test with Report-only mode to understand impact on automation and scripts
- Service principals and managed identities are not affected by user-based Conditional Access
- Users need to be MFA-registered before policy enforcement
- Consider the impact on PowerShell/CLI scripts that rely on user authentication

## Default Value

By default, no Conditional Access policy specifically requires MFA for the Windows Azure Service Management API.

## References

- [Conditional Access: Require MFA for Azure management](https://docs.microsoft.com/en-us/azure/active-directory/conditional-access/howto-conditional-access-policy-azure-management)
- [Building a Conditional Access policy](https://docs.microsoft.com/en-us/azure/active-directory/conditional-access/concept-conditional-access-policies)
- [Conditional Access cloud apps, actions, and authentication context](https://docs.microsoft.com/en-us/azure/active-directory/conditional-access/concept-conditional-access-cloud-apps)

