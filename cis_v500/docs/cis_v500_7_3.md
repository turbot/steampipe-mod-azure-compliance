## Description

Network security groups should be periodically evaluated for port misconfigurations. Where UDP is not explicitly required and narrowly configured for resources attached to a network security group, Internet-level access to Azure resources should be restricted or eliminated.

## Rationale

User Datagram Protocol (UDP) is a connectionless protocol used for various services including DNS, VPN, streaming, gaming, and IoT communications. While UDP has legitimate uses, allowing unrestricted UDP access from the Internet creates several security concerns:

**Security risks of open UDP ports:**

**Amplification attacks:**
- UDP can be exploited for DDoS amplification attacks
- Small queries can generate large responses (amplification factor)
- Attackers spoof source IPs to direct responses at victims
- Common amplification vectors: DNS, NTP, SNMP, memcached, SSDP

**Reconnaissance and scanning:**
- Open UDP ports reveal services running on systems
- Attackers can identify potential vulnerabilities
- Service fingerprinting enables targeted attacks
- Enumeration of network architecture

**Denial of Service (DoS):**
- UDP flood attacks can overwhelm systems
- No connection state makes filtering difficult
- Can saturate network bandwidth
- Affects availability of legitimate services

**Protocol-specific vulnerabilities:**
- Many UDP services have known vulnerabilities
- Outdated protocol implementations can be exploited
- Weak or no authentication in some UDP protocols
- Information disclosure through UDP services

**Data exfiltration:**
- UDP tunneling can be used to bypass security controls
- Covert channels for data exfiltration
- Difficult to track connectionless traffic
- DNS tunneling is a common technique

**Common UDP services that should not be Internet-facing:**
- Port 53 (DNS) - Use cloud DNS services or restrict to authorized servers
- Port 123 (NTP) - Use internal NTP servers or Azure Time Service
- Port 161-162 (SNMP) - Never expose to Internet
- Port 500/4500 (IKE/IPsec) - Use Azure VPN Gateway instead
- Port 1900 (SSDP) - Should never be Internet-facing
- Port 5060/5061 (SIP) - Use SIP trunking services with protection
- Port 11211 (memcached) - Should be internal only

**Legitimate UDP use cases:**
Some UDP services legitimately require Internet access:
- VPN endpoints (but use Azure VPN Gateway)
- Gaming servers (require careful configuration)
- VoIP services (use SIP trunking providers)
- Streaming services (with DDoS protection)
- IoT device communications (use Azure IoT Hub)

Even for legitimate uses, UDP access should be:
- Limited to specific required ports only
- Rate-limited where possible
- Protected by DDoS protection services
- Monitored for abuse patterns
- Combined with additional security controls

**Why unrestricted UDP access should be avoided:**
- Increases attack surface significantly
- Enables amplification attacks
- Difficult to monitor and log effectively
- No built-in protection against spoofing
- Commonly exploited in modern attacks
- Compliance frameworks often restrict UDP exposure

## Audit

**From Azure Portal:**

1. From Azure Home, select `All services`
2. Select `Network security groups` under Networking
3. For each Network Security Group:
   - Select the NSG
   - Select `Inbound security rules`
   - Review rules for:
     - Protocol: UDP
     - Source: `Any`, `Internet`, `0.0.0.0/0`, or `*`
     - Action: `Allow`
   - Verify no such rules exist, or if they do:
     - They are limited to specific required ports
     - Source is restricted to specific IP addresses
     - Business justification exists

**From Azure CLI:**

```bash
# List all NSGs
az network nsg list --query "[].{Name:name, ResourceGroup:resourceGroup}" -o table

# For each NSG, check for open UDP rules
az network nsg rule list --nsg-name <nsg-name> --resource-group <resource-group-name> --query "[?protocol=='UDP' && access=='Allow' && (sourceAddressPrefix=='*' || sourceAddressPrefix=='Internet' || sourceAddressPrefix=='0.0.0.0/0')].{Name:name, Priority:priority, Port:destinationPortRange, Source:sourceAddressPrefix}" -o table
```

**From PowerShell:**

```powershell
Connect-AzAccount

# Get all NSGs
$nsgs = Get-AzNetworkSecurityGroup

foreach ($nsg in $nsgs) {
    $udpRules = $nsg.SecurityRules | Where-Object {
        $_.Protocol -eq "UDP" -and
        $_.Access -eq "Allow" -and
        ($_.SourceAddressPrefix -eq "*" -or
         $_.SourceAddressPrefix -eq "Internet" -or
         $_.SourceAddressPrefix -eq "0.0.0.0/0")
    }

    if ($udpRules) {
        Write-Host "WARNING: NSG '$($nsg.Name)' has open UDP rules:" -ForegroundColor Red
        foreach ($rule in $udpRules) {
            Write-Host "  Rule: $($rule.Name)"
            Write-Host "    Priority: $($rule.Priority)"
            Write-Host "    Source: $($rule.SourceAddressPrefix)"
            Write-Host "    Ports: $($rule.DestinationPortRange)"
        }
    }
}
```

## Remediation

**Step 1: Identify legitimate UDP requirements**

Before removing rules, determine:
- Which UDP services are actually required
- Whether Azure services can replace them
- If specific source IPs can be defined
- Business justification for Internet access

**Step 2: Remove unnecessary UDP rules**

**From Azure Portal:**
1. From Azure Home, select `All services`
2. Select `Network security groups`
3. Select the NSG with the open UDP rule
4. Select `Inbound security rules`
5. Select the rule allowing unrestricted UDP access
6. Click `Delete`
7. Confirm the deletion

**From Azure CLI:**
```bash
az network nsg rule delete --nsg-name <nsg-name> --resource-group <resource-group-name> --name <rule-name>
```

**From PowerShell:**
```powershell
$nsg = Get-AzNetworkSecurityGroup -Name <nsg-name> -ResourceGroupName <resource-group-name>
Remove-AzNetworkSecurityRuleConfig -NetworkSecurityGroup $nsg -Name <rule-name>
$nsg | Set-AzNetworkSecurityGroup
```

**Step 3: Restrict to specific ports and sources (if UDP required)**

**From Azure Portal:**
1. Edit the UDP rule
2. Change `Protocol` to `UDP` (if using Any)
3. Change `Destination port ranges` from `*` to specific ports (e.g., `500,4500` for VPN)
4. Change `Source` from `Any` to:
   - Specific IP addresses
   - IP address ranges (CIDR)
   - Service tags if applicable
5. Click `Save`

**From Azure CLI:**
```bash
az network nsg rule update \
  --nsg-name <nsg-name> \
  --resource-group <resource-group-name> \
  --name <rule-name> \
  --protocol UDP \
  --source-address-prefixes <specific-ip>/32 \
  --destination-port-ranges <specific-port>
```

**From PowerShell:**
```powershell
$nsg = Get-AzNetworkSecurityGroup -Name <nsg-name> -ResourceGroupName <resource-group-name>
$rule = $nsg.SecurityRules | Where-Object {$_.Name -eq "<rule-name>"}
$rule.Protocol = "UDP"
$rule.SourceAddressPrefix = "<specific-ip>/32"
$rule.DestinationPortRange = "<specific-port>"
$nsg | Set-AzNetworkSecurityGroup
```

**Best Practices:**

1. **Use Azure services instead of exposing UDP**:
   - Azure VPN Gateway (instead of custom VPN on UDP 500/4500)
   - Azure DNS (instead of custom DNS servers)
   - Azure Time Sync (instead of NTP servers)
   - Azure IoT Hub (instead of direct device communication)

2. **Enable Azure DDoS Protection**:
   - Provides automatic protection against UDP amplification
   - Mitigates volumetric attacks
   - Real-time attack metrics
   - Automatic traffic scrubbing

   ```bash
   # Enable DDoS Protection Standard on VNet
   az network ddos-protection create \
     --resource-group <resource-group-name> \
     --name <ddos-plan-name>

   az network vnet update \
     --resource-group <resource-group-name> \
     --name <vnet-name> \
     --ddos-protection true \
     --ddos-protection-plan <ddos-plan-id>
   ```

3. **Implement rate limiting**:
   - Use Azure Firewall for advanced traffic filtering
   - Implement application-level rate limiting
   - Monitor for unusual traffic patterns

4. **Monitoring and alerting**:
   - Enable NSG flow logs
   - Monitor UDP traffic patterns
   - Alert on UDP floods or unusual patterns
   - Use Azure Network Watcher

5. **Service-specific hardening**:
   - **DNS**: Use Azure DNS or restrict to known resolvers
   - **NTP**: Use Azure Time Service or internal NTP pool
   - **SNMP**: Never expose externally, use Azure Monitor instead
   - **VPN**: Use Azure VPN Gateway with proper configuration

6. **Network segmentation**:
   - Isolate services requiring UDP in separate subnets
   - Apply strict NSG rules per subnet
   - Use Azure Firewall for centralized control
   - Implement micro-segmentation

7. **Regular audits**:
   - Review UDP rules quarterly
   - Validate business justification
   - Check for unused rules
   - Monitor for abuse

8. **Documentation**:
   - Document why each UDP rule exists
   - Maintain inventory of UDP services
   - Track responsible parties
   - Regular review schedule

## Default Value

By default, Network Security Groups do not allow UDP traffic from the Internet. Any UDP allow rules must be explicitly created by administrators and should be carefully reviewed.

## References

- [Network security groups](https://docs.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview)
- [Azure DDoS Protection](https://docs.microsoft.com/en-us/azure/ddos-protection/ddos-protection-overview)
- [Azure VPN Gateway](https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpngateways)
- [NSG flow logs](https://docs.microsoft.com/en-us/azure/network-watcher/network-watcher-nsg-flow-logging-overview)
- [Azure Firewall](https://docs.microsoft.com/en-us/azure/firewall/overview)
- [Network security best practices](https://docs.microsoft.com/en-us/azure/security/fundamentals/network-best-practices)

