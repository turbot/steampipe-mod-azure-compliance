## Description

Ensure that any roles granting read, write, or owner permissions are removed from disabled Azure user accounts. While an automated assessment procedure exists for this recommendation, the assessment status remains manual. Removing role assignments from disabled user accounts depends on the context and requirements of each organization and environment.

## Rationale

When user accounts are disabled in Microsoft Entra ID, they should not retain any role assignments or permissions. Disabled accounts typically belong to:
- Former employees who have left the organization
- Employees on extended leave
- Compromised accounts that have been disabled for security reasons
- Service accounts that are no longer in use

Leaving role assignments on disabled accounts creates security risks:
- If the account is re-enabled accidentally or maliciously, it retains all its previous permissions
- It makes auditing and permission management more difficult
- It violates the principle of least privilege
- Compromised credentials for disabled accounts could still be valuable to attackers if permissions remain
- It may violate compliance requirements for timely access revocation

All role assignments should be removed from disabled accounts as part of the account deactivation process.

## Audit

**From Azure Portal:**

1. **Identify disabled users:**
   - From Azure Home open the portal menu in the top left, and select `Microsoft Entra ID`
   - Select `Users`
   - Click `Add filters`
   - Select `Account enabled` and filter by `No`
   - Note all disabled user accounts

2. **Check role assignments:**
   - From Azure Home, select `Subscriptions`
   - For each subscription:
     - Select the subscription
     - Click `Access control (IAM)`
     - Click `Role assignments`
     - Search for each disabled user identified above
     - Document any role assignments found

**From PowerShell:**

```powershell
Connect-AzureAD
Connect-AzAccount

# Get all disabled users
$disabledUsers = Get-AzureADUser -All $true | Where-Object {$_.AccountEnabled -eq $false}

Write-Host "Checking role assignments for disabled users..."
foreach ($user in $disabledUsers) {
    Write-Host "`nUser: $($user.UserPrincipalName) (Disabled)"

    # Check Azure RBAC role assignments
    $subscriptions = Get-AzSubscription
    foreach ($sub in $subscriptions) {
        Set-AzContext -SubscriptionId $sub.Id
        $roleAssignments = Get-AzRoleAssignment -SignInName $user.UserPrincipalName -ErrorAction SilentlyContinue
        if ($roleAssignments) {
            Write-Host "  Subscription: $($sub.Name)"
            foreach ($assignment in $roleAssignments) {
                Write-Host "    Role: $($assignment.RoleDefinitionName)"
                Write-Host "    Scope: $($assignment.Scope)"
            }
        }
    }

    # Check Entra ID directory roles
    $directoryRoles = Get-AzureADDirectoryRole
    foreach ($role in $directoryRoles) {
        $members = Get-AzureADDirectoryRoleMember -ObjectId $role.ObjectId
        if ($members.ObjectId -contains $user.ObjectId) {
            Write-Host "  Entra ID Role: $($role.DisplayName)"
        }
    }
}
```

**From Azure CLI:**

```bash
# Get disabled users
az ad user list --filter "accountEnabled eq false" --query "[].{UPN:userPrincipalName, Name:displayName}" -o table

# For each disabled user, check role assignments
# Replace <user-upn> with the actual user principal name
az role assignment list --assignee <user-upn> --all --query "[].{Role:roleDefinitionName, Scope:scope}" -o table
```

## Remediation

**From Azure Portal:**

1. **Remove Azure RBAC role assignments:**
   - From Azure Home, select `Subscriptions`
   - Select a subscription
   - Click `Access control (IAM)`
   - Click `Role assignments`
   - Find the disabled user's role assignment
   - Select the assignment and click `Remove`
   - Repeat for all subscriptions and management groups

2. **Remove Entra ID directory role assignments:**
   - From Azure Home open the portal menu in the top left, and select `Microsoft Entra ID`
   - Select `Roles and administrators`
   - For each role, check if the disabled user is assigned
   - If assigned, click on the role, select the user, and click `Remove assignment`

**From PowerShell:**

```powershell
Connect-AzureAD
Connect-AzAccount

# Remove Azure RBAC role assignments for a disabled user
$userUPN = "<disabled-user@example.com>"
$subscriptions = Get-AzSubscription

foreach ($sub in $subscriptions) {
    Set-AzContext -SubscriptionId $sub.Id
    $roleAssignments = Get-AzRoleAssignment -SignInName $userUPN -ErrorAction SilentlyContinue
    foreach ($assignment in $roleAssignments) {
        Remove-AzRoleAssignment -ObjectId $assignment.ObjectId -RoleDefinitionName $assignment.RoleDefinitionName -Scope $assignment.Scope
        Write-Host "Removed $($assignment.RoleDefinitionName) from $userUPN in $($sub.Name)"
    }
}

# Remove Entra ID directory role assignments
$user = Get-AzureADUser -Filter "userPrincipalName eq '$userUPN'"
$directoryRoles = Get-AzureADDirectoryRole
foreach ($role in $directoryRoles) {
    $members = Get-AzureADDirectoryRoleMember -ObjectId $role.ObjectId
    if ($members.ObjectId -contains $user.ObjectId) {
        Remove-AzureADDirectoryRoleMember -ObjectId $role.ObjectId -MemberId $user.ObjectId
        Write-Host "Removed $($role.DisplayName) role from $userUPN"
    }
}
```

**From Azure CLI:**

```bash
# Remove all role assignments for a disabled user
USER_UPN="<disabled-user@example.com>"
az role assignment delete --assignee $USER_UPN --all
```

**Best Practice - Automate as part of offboarding:**

Create an automated workflow that:
1. Disables the user account
2. Removes all role assignments (Azure RBAC and Entra ID roles)
3. Removes group memberships
4. Logs all actions for audit purposes
5. Notifies security team of completion

## Default Value

By default, role assignments are not automatically removed when a user account is disabled.

## References

- [Understand Azure role assignments](https://docs.microsoft.com/en-us/azure/role-based-access-control/role-assignments)
- [Remove Azure role assignments](https://docs.microsoft.com/en-us/azure/role-based-access-control/role-assignments-remove)
- [Azure AD roles](https://docs.microsoft.com/en-us/azure/active-directory/roles/permissions-reference)

