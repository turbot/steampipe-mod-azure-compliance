## Description

Require administrators to provide consent for applications before use.

## Rationale

User consent for applications allows users to grant third-party applications access to organizational data and resources. While this can enable productivity and collaboration, it also introduces significant security risks:

**Data exfiltration risks:**
- Applications can request access to sensitive data (emails, files, calendar, contacts)
- Users may not fully understand the scope of permissions they're granting
- Malicious applications can harvest organizational data
- Once consent is granted, the app has ongoing access to data

**Security and compliance concerns:**
- Users may grant excessive permissions to untrusted applications
- No IT oversight of what applications access organizational data
- Difficulty tracking and managing third-party application access
- Potential violations of data protection regulations (GDPR, CCPA, etc.)
- Shadow IT proliferation

**Attack vectors:**
- Consent phishing attacks trick users into granting malicious apps access
- Compromised applications can be used as a foothold into the organization
- Applications may have security vulnerabilities
- Lack of vetting for application security and data handling practices

By disabling user consent and requiring administrator approval:
- IT can review and vet applications before they access organizational data
- Security team can assess application permissions and legitimacy
- Centralized control over third-party access
- Better audit trail of approved applications
- Reduced risk of consent phishing attacks
- Compliance with data protection regulations

## Audit

**From Azure Portal:**

1. From Azure Home open the portal menu in the top left, and select `Microsoft Entra ID`
2. Select `Enterprise applications`
3. Select `Consent and permissions`
4. Select `User consent settings`
5. Check the current setting:
   - Verify that `User consent for applications` is set to `Do not allow user consent`

**From PowerShell:**

```powershell
Connect-AzureAD
$policy = Get-AzureADMSAuthorizationPolicy
Write-Host "User consent setting: $($policy.PermissionGrantPolicyIdsAssignedToDefaultUserRole)"
```

If the result is an empty array or does not include any permission grant policies, user consent is disabled.

**From Microsoft Graph API:**

```bash
az rest --method GET --uri "https://graph.microsoft.com/v1.0/policies/authorizationPolicy" --query "defaultUserRolePermissions.permissionGrantPoliciesAssigned"
```

Should return an empty array or null.

## Remediation

**From Azure Portal:**

1. From Azure Home open the portal menu in the top left, and select `Microsoft Entra ID`
2. Select `Enterprise applications`
3. Select `Consent and permissions`
4. Select `User consent settings`
5. Under `User consent for applications`, select `Do not allow user consent`
6. Click `Save`

**Note:** After making this change:
- Users will not be able to consent to applications
- Admin consent will be required for all new applications
- Users can request admin consent through the admin consent workflow (recommended to enable)

**From PowerShell:**

```powershell
Connect-AzureAD
$policy = Get-AzureADMSAuthorizationPolicy

# Disable user consent by setting empty permission grant policies
$policy.PermissionGrantPolicyIdsAssignedToDefaultUserRole = @()
Set-AzureADMSAuthorizationPolicy -Id $policy.Id -PermissionGrantPolicyIdsAssignedToDefaultUserRole $policy.PermissionGrantPolicyIdsAssignedToDefaultUserRole
```

**From Microsoft Graph API:**

```bash
az rest --method PATCH \
  --uri "https://graph.microsoft.com/v1.0/policies/authorizationPolicy/authorizationPolicy" \
  --headers "Content-Type=application/json" \
  --body '{"defaultUserRolePermissions":{"permissionGrantPoliciesAssigned":[]}}'
```

**Best Practices after implementing this control:**

1. **Enable Admin Consent Workflow:**
   - From `Enterprise applications` > `Consent and permissions` > `Admin consent requests`
   - Enable the workflow so users can request admin consent
   - Configure reviewers (admins who can approve requests)
   - Set notification recipients
   - Configure request expiration

2. **Establish application vetting process:**
   - Create criteria for approving applications
   - Review application publisher verification status
   - Assess requested permissions (principle of least privilege)
   - Check application security practices and compliance
   - Document approval decisions

3. **User communication:**
   - Inform users about the change and reasons
   - Provide instructions for requesting admin consent
   - Explain expected approval timelines
   - Offer alternative approved applications where possible

4. **Regular reviews:**
   - Periodically review all consented applications
   - Remove access for unused applications
   - Re-evaluate permissions of existing applications
   - Monitor for suspicious application activity

## Default Value

By default, user consent settings vary by tenant age and configuration. Newer tenants may have more restrictive settings, while older tenants might allow user consent. Organizations should explicitly configure this setting.

## References

- [Configure how users consent to applications](https://docs.microsoft.com/en-us/azure/active-directory/manage-apps/configure-user-consent)
- [Configure the admin consent workflow](https://docs.microsoft.com/en-us/azure/active-directory/manage-apps/configure-admin-consent-workflow)
- [Understanding Azure AD application consent experiences](https://docs.microsoft.com/en-us/azure/active-directory/develop/application-consent-experience)
- [Permissions and consent in the Microsoft identity platform](https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-permissions-and-consent)

