## Description

The 'No Public IP' setting should be enabled to prevent public IP addresses from being assigned to cluster nodes, reducing exposure to the internet.

## Rationale

By default, Databricks cluster nodes are assigned public IP addresses. Enabling "No Public IP" (also known as Secure Cluster Connectivity):
- Prevents cluster nodes from having public IP addresses
- Reduces attack surface by eliminating direct internet exposure
- Forces all communication through Azure's private network
- Maintains outbound connectivity through NAT gateways
- Eliminates the need for inbound NSG rules
- Provides better network isolation and security

This feature ensures that cluster nodes are not directly accessible from the internet while still allowing them to communicate with Databricks control plane and Azure services.

## Audit

**From Azure Portal:**

1. Go to `Azure Databricks`
2. Select the workspace
3. Under `Networking`, check `Secure cluster connectivity`
4. Verify that it is set to `Enabled`

**Alternative check via workspace properties:**

1. Go to `Azure Databricks`
2. Select the workspace
3. Click `JSON View`
4. Look for `"enableNoPublicIp": true` in the properties

**From Azure CLI:**

```bash
az databricks workspace show \
  --name <workspace-name> \
  --resource-group <resource-group-name> \
  --query "parameters.enableNoPublicIp.value"
```

## Remediation

**From Azure Portal:**

Note: This setting must be configured during workspace creation and cannot be changed afterward.

1. Go to `Azure Databricks`
2. Click `+ Create`
3. Fill in the basic workspace details
4. Go to `Networking` tab
5. Deploy workspace in your VNet (VNet injection required)
6. Enable `Secure cluster connectivity (No Public IP)`
7. Complete the workspace creation

**From Azure CLI:**

```bash
az databricks workspace create \
  --name <workspace-name> \
  --resource-group <resource-group-name> \
  --location <location> \
  --sku premium \
  --enable-no-public-ip \
  --virtual-network <vnet-id> \
  --public-subnet-name <public-subnet-name> \
  --private-subnet-name <private-subnet-name>
```

**For Existing Workspaces:**

If the workspace was created without this setting, you must:

1. Export notebooks, jobs, and configurations
2. Create a new workspace with "No Public IP" enabled
3. Import notebooks and reconfigure settings
4. Migrate data to the new workspace
5. Update references and connection strings
6. Delete the old workspace

**Additional Considerations:**

- Ensure NAT gateway or Azure Firewall is configured for outbound internet access
- Update NSG rules to remove inbound public internet rules
- Test connectivity to external services after migration

## References

- [Secure cluster connectivity (No Public IP)](https://docs.microsoft.com/en-us/azure/databricks/security/network/secure-cluster-connectivity)
- [VNet injection](https://docs.microsoft.com/en-us/azure/databricks/administration-guide/cloud-configurations/azure/vnet-inject)

