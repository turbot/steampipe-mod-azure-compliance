## Description

Limit guest user permissions.

## Rationale

Guest users in Microsoft Entra ID are external users invited to collaborate with your organization. By default, guest users have certain permissions to browse directory information, which may expose more information than necessary.

Azure AD offers three levels of guest user access restrictions:

1. **Guest users have the same access as members (most inclusive)** - Not recommended
   - Guests can enumerate all users, groups, and other directory objects
   - Same level of access as regular users
   - High risk of information disclosure

2. **Guest users have limited access to properties and memberships of directory objects** - Recommended baseline
   - Guests can see limited information about other users
   - Can see groups they're members of
   - Cannot enumerate all directory objects
   - Balanced security and collaboration

3. **Guest user access is restricted to properties and memberships of their own directory objects (most restrictive)** - Recommended for high-security environments
   - Guests can only see their own profile
   - Can see memberships of groups they belong to
   - Cannot browse or discover other users or groups
   - Minimal information disclosure

The most restrictive option (option 3) is recommended because:
- **Minimizes information disclosure** to external parties
- **Follows principle of least privilege** - guests should only access what they need
- **Reduces reconnaissance opportunities** for potential attackers
- **Protects organizational structure** information from external view
- **Compliance with data protection** requirements
- **Limits guest users' ability to discover** internal users and resources

Even trusted external collaborators don't need to browse your entire directory to do their work effectively.

## Audit

**From Azure Portal:**

1. From Azure Home open the portal menu in the top left, and select `Microsoft Entra ID`
2. Select `Users`
3. Select `User settings`
4. Click `Manage external collaboration settings`
5. Under `Guest user access restrictions`, check the current setting
6. Verify it is set to: `Guest user access is restricted to properties and memberships of their own directory objects`

**From PowerShell:**

```powershell
Connect-AzureAD
$policy = Get-AzureADMSAuthorizationPolicy
Write-Host "Guest user role ID: $($policy.GuestUserRoleId)"
```

The GuestUserRoleId should be `2af84b1e-32c8-42b7-82bc-daa82404023b` (most restrictive).

**From Microsoft Graph API:**

```bash
az rest --method GET --uri "https://graph.microsoft.com/v1.0/policies/authorizationPolicy" --query "guestUserRoleId"
```

## Remediation

**From Azure Portal:**

1. From Azure Home open the portal menu in the top left, and select `Microsoft Entra ID`
2. Select `Users`
3. Select `User settings`
4. Click `Manage external collaboration settings`
5. Under `Guest user access restrictions`, select:
   - `Guest user access is restricted to properties and memberships of their own directory objects`
6. Click `Save`

**From PowerShell:**

```powershell
Connect-AzureAD
$policy = Get-AzureADMSAuthorizationPolicy

# Set the most restrictive guest user role
$policy.GuestUserRoleId = "2af84b1e-32c8-42b7-82bc-daa82404023b"
Set-AzureADMSAuthorizationPolicy -Id $policy.Id -GuestUserRoleId $policy.GuestUserRoleId
```

**From Microsoft Graph API:**

```bash
az rest --method PATCH \
  --uri "https://graph.microsoft.com/v1.0/policies/authorizationPolicy/authorizationPolicy" \
  --headers "Content-Type=application/json" \
  --body '{"guestUserRoleId":"2af84b1e-32c8-42b7-82bc-daa82404023b"}'
```

**Guest User Role IDs:**

- `a0b1b346-4d3e-4e8b-98f8-753987be4970` - Guest users have the same access as members (least restrictive)
- `10dae51f-b6af-4016-8d66-8c2a99b929b3` - Guest users have limited access (moderate)
- `2af84b1e-32c8-42b7-82bc-daa82404023b` - Guest user access is restricted to their own objects (most restrictive, recommended)

**Best Practices:**

1. **Resource-specific access:**
   - Use SharePoint, Teams, or app-specific permissions to grant access
   - Don't rely on directory-level permissions for collaboration
   - Grant access to specific resources guest users need

2. **Guest user reviews:**
   - Regularly review guest user accounts (see recommendation 5.3.2)
   - Remove guest users who no longer need access
   - Verify guest users still require their current permissions

3. **Access packages (Azure AD Entitlement Management):**
   - Use access packages to manage guest user lifecycle
   - Automatically remove access after a specified time
   - Require regular access reviews

4. **Conditional Access for guests:**
   - Apply Conditional Access policies specific to guest users
   - Require MFA for guest access
   - Restrict guest access from certain locations
   - Require compliant or managed devices

5. **Communication with guests:**
   - Set expectations about access levels
   - Provide clear instructions for accessing shared resources
   - Document how to request additional access if needed

6. **Monitor guest activity:**
   - Review sign-in logs for guest users
   - Monitor access to sensitive resources by guests
   - Alert on suspicious guest user behavior

7. **Guest invitation policies:**
   - Control who can invite guests (see recommendation 5.16)
   - Implement approval workflows for guest invitations
   - Use domains allowlist/blocklist as appropriate

## Default Value

The default setting may vary, but typically guest users have more permissions than the most restrictive option. Organizations should explicitly configure this to the most restrictive setting.

## References

- [Default user permissions in Azure Active Directory](https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/users-default-permissions)
- [What is guest user access in Azure Active Directory B2B?](https://docs.microsoft.com/en-us/azure/active-directory/external-identities/what-is-b2b)
- [Configure external collaboration settings](https://docs.microsoft.com/en-us/azure/active-directory/external-identities/delegate-invitations)
- [Manage guest access with access reviews](https://docs.microsoft.com/en-us/azure/active-directory/governance/manage-guest-access-with-access-reviews)

